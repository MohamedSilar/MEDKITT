response = Map();
response.put("action","context");
response.put("context_id",context_id);
//------------------------------------------------------
if(context_id == "care_main")
{
	choice = ifnull(answers.get("care_main").get("text"),"");
	if(choice.containsIgnoreCase("Back"))
	{
		response.put("action","context");
		response.put("context_id","care_main");
		q = {"name":"care_main","replies":{"ğŸ©º Welcome to *MedKit Wellness Hub*!"},"suggestions":{"Child Care ğŸ‘¶","Glow Care âœ¨","Health Care ğŸ©º","ğŸ§  Mind Care","Weather Care ğŸ˜·","Main Menu"}};
		response.put("questions",{q});
	}
	if(choice.containsIgnoreCase("Child Care"))
	{
		response.put("action","context");
		response.put("context_id","child_menu");
		q = {"name":"child_menu","replies":{"ğŸ‘¶ *Child Care & Parenting Guide*"},"suggestions":{"ğŸ¼ Baby Nutrition","ğŸ’‰ Vaccine Guide","ğŸ§¸ Child Safety","Back"}};
		response.put("questions",{q});
		return response;
	}
	if(choice.containsIgnoreCase("Glow Care âœ¨"))
	{
		response.put("action","context");
		response.put("context_id","skin_menu");
		q = {"name":"skin_menu","replies":{"âœ¨ Welcome to **Glow Care** â€” your personal skin & hair wellness guide!"},"suggestions":{"âœ¨ Skin Care Tips","ğŸ’‡â€â™€ï¸ Hair Checkup","ğŸ§´ Medzon Products","Back"}};
		response.put("questions",{q});
		return response;
	}
	if(choice.containsIgnoreCase("Weather Care"))
	{
		response.put("action","context");
		response.put("context_id","weather_care");
		q = {"name":"location","replies":{"ğŸŒ¤ *Weather Health Tips*","Could you tell me your location? ğŸŒ"},"input":{"type":"location","radius":"10 kms","label":"Share Location","select_label":"Send my location"}};
		response.put("questions",{q});
		return response;
	}
	if(choice.containsIgnoreCase("Mind Care"))
	{
		response.put("action","context");
		response.put("context_id","mindcheck_menu");
		q = {"name":"mind_option","replies":{"Let's explore your **Mind Wellness** ğŸ˜Š"},"suggestions":{"Mood Check","Daily Affirmations","Journaling Prompts","Back"}};
		response.put("questions",{q});
		return response;
	}
	if(choice.containsIgnoreCase("Health Care"))
	{
		response.put("action","context");
		response.put("context_id","health_hub");
		q = {"name":"health_hub","replies":{"Welcome to **Health Hub** ğŸ©º! Choose an option:"},"suggestions":{"ğŸ” Search Hospitals","Tablet Info ğŸ’Š","ğŸ“ Emergency Contacts","Health News ğŸ“°","Back"}};
		response.put("questions",{q});
		return response;
	}
	if(choice.equalsIgnoreCase("Main Menu"))
	{
		response.put("action","context");
		response.put("context_id","mainmenu");
		question = {"name":"select","replies":{"Hey buddy ğŸ™‹â€â™‚ï¸ Welcome to **MedKit** ğŸ©º! I'm here to guide you. Tell me what you'd like to do!"},"suggestions":{"MedKit Wellness Hub ğŸŒ¿","ğŸ‹ï¸ FitZone","ProcureX ğŸ›’","ğŸ’¬ Motivational Boost","ğŸ¤ Consult an Expert","ğŸ“ Help Desk"}};
		response.put("questions",{question});
		return response;
	}
}
if(context_id == "child_menu")
{
	opt = ifnull(answers.get("child_menu").get("text"),"");
	childSug = {"Thank You","Back"};
	if(opt.containsIgnoreCase("Baby Nutrition"))
	{
		response.put("action","context");
		response.put("context_id","baby_nutri");
		q = {"name":"food_name","replies":{"ğŸ¼ *Baby Nutrition*","Enter a **Food Name** to fetch nutrition details.","**Eg: mashed banana,porridge, apple puree**"},"input":{"type":"name","placeholder":"Eg. mashed banana"}};
		response.put("questions",{q});
		return response;
	}
	else if(opt.containsIgnoreCase("Vaccine Guide"))
	{
		if(answers.containsKey("vaccine_select"))
		{
			backTxt = ifnull(answers.get("vaccine_select").get("text"),"").toLowerCase().trim();
			if(backTxt.contains("back"))
			{
				response = Map();
				response.put("action","context");
				response.put("context_id","child_menu");
				q = {"name":"child_menu","replies":{"ğŸ‘¶ *Child Care & Parenting Guide*"},"suggestions":{"ğŸ¼ Baby Nutrition","ğŸ’‰ Vaccine Guide","ğŸ§¸ Child Safety","Back"}};
				response.put("questions",{q});
				return response;
			}
		}
		vaccineText = "ğŸ’‰ *Child Immunization Schedule*\n";
		vaccineText = vaccineText + "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n";
		vaccineText = vaccineText + "ğŸ‘¶ *At Birth*\n";
		vaccineText = vaccineText + "â€¢ BCG\n";
		vaccineText = vaccineText + "â€¢ OPV (0 dose)\n";
		vaccineText = vaccineText + "â€¢ Hepatitis B (Birth dose)\n\n";
		vaccineText = vaccineText + "ğŸ¼ *6 Weeks*\n";
		vaccineText = vaccineText + "â€¢ Pentavalent Vaccine (1st dose)\n";
		vaccineText = vaccineText + "â€¢ OPV (1st dose)\n";
		vaccineText = vaccineText + "â€¢ Rotavirus (1st dose)\n";
		vaccineText = vaccineText + "â€¢ IPV â€“ Fractional (1st dose)\n\n";
		vaccineText = vaccineText + "ğŸ¼ *10 Weeks*\n";
		vaccineText = vaccineText + "â€¢ Pentavalent Vaccine (2nd dose)\n";
		vaccineText = vaccineText + "â€¢ OPV (2nd dose)\n";
		vaccineText = vaccineText + "â€¢ Rotavirus (2nd dose)\n\n";
		vaccineText = vaccineText + "ğŸ¼ *14 Weeks*\n";
		vaccineText = vaccineText + "â€¢ Pentavalent Vaccine (3rd dose)\n";
		vaccineText = vaccineText + "â€¢ OPV (3rd dose)\n";
		vaccineText = vaccineText + "â€¢ Rotavirus (3rd dose)\n";
		vaccineText = vaccineText + "â€¢ IPV â€“ Fractional (2nd dose)\n\n";
		vaccineText = vaccineText + "ğŸ§’ *9â€“12 Months*\n";
		vaccineText = vaccineText + "â€¢ MR (Measlesâ€“Rubella) â€“ 1st dose\n";
		vaccineText = vaccineText + "â€¢ Vitamin A â€“ 1st dose\n\n";
		vaccineText = vaccineText + "ğŸ§’ *16â€“24 Months*\n";
		vaccineText = vaccineText + "â€¢ DPT Booster\n";
		vaccineText = vaccineText + "â€¢ OPV Booster\n";
		vaccineText = vaccineText + "â€¢ MR â€“ 2nd dose\n\n";
		vaccineText = vaccineText + "ğŸ’ *5â€“6 Years*\n";
		vaccineText = vaccineText + "â€¢ DPT Booster (2nd booster)\n\n";
		vaccineText = vaccineText + "ğŸ§‘ *10â€“16 Years*\n";
		vaccineText = vaccineText + "â€¢ Td / TT Vaccine\n\n";
		vaccineText = vaccineText + "_âš ï¸ Always follow your pediatricianâ€™s official schedule._";
		question = {"name":"vaccine_select","replies":{vaccineText},"suggestions":{"Back"}};
		response = Map();
		response.put("action","context");
		response.put("context_id","child_menu");
		response.put("questions",{question});
		return response;
	}
	else if(opt.containsIgnoreCase("Child Safety"))
	{
		if(answers.containsKey("child_safety"))
		{
			backTxt = ifnull(answers.get("child_safety").get("text"),"").toLowerCase().trim();
			if(backTxt.contains("back"))
			{
				response = Map();
				response.put("action","context");
				response.put("context_id","child_menu");
				q = {"name":"child_menu","replies":{"ğŸ‘¶ *Child Care & Parenting Guide*"},"suggestions":{"ğŸ¼ Baby Nutrition","ğŸ’‰ Vaccine Guide","ğŸ§¸ Child Safety","Back"}};
				response.put("questions",{q});
				return response;
			}
		}
		WHO_GHO_BASE_URL = "https://ghoapi.azureedge.net/api";
		try 
		{
			ignore = invokeurl
			[
				url :WHO_GHO_BASE_URL + "/Indicator?$top=1"
				type :GET
			];
		}
		catch (e)
		{
		}
		contentLines = {"ğŸ§¸ *Child Safety â€“ Quick Tips*","Here are some basic safety tips at home:","â€¢ Keep medicines and small objects out of reach.","â€¢ Use corner guards & plug / socket covers.","â€¢ Never leave babies unattended on beds or sofas.","â€¢ Always install safety gates on stairs.","","Take care of your children well â¤ï¸"};
		question = {"name":"child_safety","replies":contentLines,"suggestions":{"Back"}};
		respMap = Map();
		respMap.put("action","context");
		respMap.put("context_id","child_menu");
		respMap.put("questions",{question});
		return respMap;
	}
	else
	{
		response.put("action","context");
		response.put("context_id","care_main");
		q = {"name":"care_main","replies":{"ğŸ©º Welcome to *MedKit Wellness Hub*!"},"suggestions":{"Child Care ğŸ‘¶","Glow Care âœ¨","Health Care ğŸ©º","ğŸ§  Mind Care","Weather Care ğŸ˜·","Main Menu"}};
		response.put("questions",{q});
		return response;
	}
}
if(context_id == "health_hub")
{
	opt_trim = ifnull(answers.get("health_hub").get("text"),"");
	if(opt_trim.containsIgnoreCase("Search Hospitals") || opt_trim.containsIgnoreCase("Search More") || opt_trim.containsIgnoreCase("Hospitals"))
	{
		response.put("action","context");
		response.put("context_id","search_hospitals");
		question = {"name":"city_name","replies":{"Please enter the **City Name** where you want to find hospitals (e.g., Madurai)."},"input":{"type":"name","placeholder":"Eg. Madurai, Chennai, Mumbai...","value":"","error":{"Enter a valid city name"}},"suggestions":{"Main Menu"}};
		response.put("questions",{question});
		return response;
	}
	else if(opt_trim.containsIgnoreCase("Tablet Info") || opt_trim.containsIgnoreCase("Tablet"))
	{
		response.put("action","context");
		response.put("context_id","tablet_info");
		question = {"name":"tablet_name","replies":{"Please enter the **Tablet Name** you want information about (e.g., Paracetamol)."},"input":{"type":"name","placeholder":"Eg. Paracetamol, Ibuprofen","value":"","error":{"Enter a valid tablet name"}},"suggestions":{"Main Menu","Back"}};
		response.put("questions",{question});
		return response;
	}
	else if(opt_trim.containsIgnoreCase("Health News") || opt_trim.containsIgnoreCase("Health News"))
	{
		if(answers.containsKey("health_news"))
		{
			backTxt = ifnull(answers.get("health_news").get("text"),"").toLowerCase().trim();
			if(backTxt.contains("back"))
			{
				response = Map();
				response.put("action","context");
				response.put("context_id","health_hub");
				q = {"name":"health_hub","replies":{"Welcome to **Health Hub** ğŸ©º! Choose an option:"},"suggestions":{"ğŸ” Search Hospitals","Tablet Info ğŸ’Š","ğŸ“ Emergency Contacts","Health News ğŸ“°","Back"}};
				response.put("questions",{q});
				return response;
			}
		}
		GNEWS_BASE_URL = "https://gnews.io/api/v4";
		try 
		{
			newsUrl = GNEWS_BASE_URL + "/top-headlines?topic=health&country=in&lang=en&max=5";
			newsResp = invokeurl
			[
				url :newsUrl
				type :GET
				connection:"gnews_salesiq"
			];
			articles = newsResp.get("articles");
			if(articles == null || articles.size() == 0)
			{
				question = {"name":"health_news","replies":{"âŒ No recent health headlines available right now."},"suggestions":{"Back"}};
				respMap = Map();
				respMap.put("action","context");
				respMap.put("context_id","health_hub");
				respMap.put("questions",{question});
				return respMap;
			}
			text = "ğŸ“° *Top Health Headlines (India)*\n\n";
			count = 0;
			for each  art in articles
			{
				if(count >= 5)
				{
					break;
				}
				title = ifnull(art.get("title"),"");
				urlArt = ifnull(art.get("url"),"");
				if(title != "")
				{
					cleanUrl = urlArt;
					if(cleanUrl != null && cleanUrl != "")
					{
						cleanUrl = cleanUrl.replaceAll("<br>","").replaceAll("<br/>","").replaceAll("<br />","").trim();
					}
					text = text + "â€¢ *" + title + "*\n";
					if(cleanUrl != null && cleanUrl != "")
					{
						text = text + cleanUrl + "\n\n";
					}
					else
					{
						text = text + "\n";
					}
					count = count + 1;
				}
			}
			text = text + "_Source: GNews.io â€“ open links to read full articles._";
			question = {"name":"health_news","replies":{text},"suggestions":{"Back"}};
			respMap = Map();
			respMap.put("action","context");
			respMap.put("context_id","health_hub");
			respMap.put("questions",{question});
			return respMap;
		}
		catch (e)
		{
			info "GNEWS ERROR ===>";
			info e;
			question = {"name":"health_news","replies":{"âš ï¸ Couldnâ€™t fetch health news right now.","Please try again later."},"suggestions":{"Back"}};
			respErr = Map();
			respErr.put("action","context");
			respErr.put("context_id","health_hub");
			respErr.put("questions",{question});
			return respErr;
		}
	}
	else if(opt_trim.containsIgnoreCase("Back") || opt_trim.containsIgnoreCase("back"))
	{
		response.put("action","context");
		response.put("context_id","care_main");
		q = {"name":"care_main","replies":{"ğŸ©º Welcome to *MedKit Wellness Hub*!"},"suggestions":{"Child Care ğŸ‘¶","Glow Care âœ¨","Health Care ğŸ©º","ğŸ§  Mind Care","Weather Care ğŸ˜·","Main Menu"}};
		response.put("questions",{q});
		return response;
	}
	else if(opt_trim.containsIgnoreCase("Emergency Contacts") || opt_trim.containsIgnoreCase("Emergency") || opt_trim.containsIgnoreCase("Contacts"))
	{
		cards = List();
		c1 = {"type":"text","text":"ğŸš” Police â€” Local Police Control Room (India)\nPhone: 100"};
		cards.add(c1);
		c2 = {"type":"text","text":"ğŸš‘ Ambulance â€” Emergency Medical Services (India)\nPhone: 108"};
		cards.add(c2);
		c3 = {"type":"text","text":"ğŸ”¥ Fire & Rescue (India)\nPhone: 101"};
		cards.add(c3);
		c4 = {"type":"text","text":"ğŸ‘©â€ğŸ¦° Women Safety Helpline (India)\nPhone: 1091"};
		cards.add(c4);
		c5 = {"type":"text","text":"âš¡ Electricity / Power Outage Helpline (India)\nPhone: 1912"};
		cards.add(c5);
		c6 = {"type":"text","text":"ğŸ§  Mental Health / Suicide Prevention Helpline (India)\nPhone: 08046110007"};
		cards.add(c6);
		c7 = {"type":"text","text":"ğŸ‡®ğŸ‡³ 112 â€” National Emergency Number (All India)\nPhone: 112"};
		cards.add(c7);
		response.put("action","context");
		response.put("context_id","health_hub");
		q = Map();
		q.put("name","health_hub");
		q.put("replies",cards);
		sugs = List();
		sugs.add("Search Hospitals");
		sugs.add("Back");
		q.put("suggestions",sugs);
		response.put("questions",{q});
		return response;
	}
	else if(opt_trim.containsIgnoreCase("Main Menu"))
	{
		response.put("action","context");
		response.put("context_id","mainmenu");
		question = {"name":"select","replies":{"Hey buddy ğŸ™‹â€â™‚ï¸ Welcome to **MedKit** ğŸ©º! I'm here to guide you. Tell me what you'd like to do!"},"suggestions":{"MedKit Wellness Hub ğŸŒ¿","ğŸ‹ï¸ FitZone","ProcureX ğŸ›’","ğŸ’¬ Motivational Boost","ğŸ¤ Consult an Expert","ğŸ“ Help Desk"}};
		response.put("questions",{question});
		return response;
	}
	else
	{
		response.put("action","context");
		response.put("context_id","care_main");
		q = {"name":"care_main","replies":{"ğŸ©º Welcome to *MedKit Wellness Hub*!"},"suggestions":{"Child Care ğŸ‘¶","Glow Care âœ¨","Health Care ğŸ©º","ğŸ§  Mind Care","Weather Care ğŸ˜·","Main Menu"}};
		response.put("questions",{q});
		return response;
	}
}
// --------------------------------------------------------------------------------------
if(context_id != null && context_id.equals("mindcheck_menu"))
{
	ans = "";
	try 
	{
		ans = ifnull(answers.get("mind_option").get("text"),"");
	}
	catch (e)
	{
		ans = "";
	}
	if(ans.equalsIgnoreCase("Mood Check"))
	{
		response.put("action","context");
		response.put("context_id","mind_mood_check");
		question = {"name":"mood_rating","replies":{"Choose your current **Mood Rating:** (1â€“4 ğŸ˜¢ Sad, 5â€“7 ğŸ˜ Neutral, 8â€“10 ğŸ˜Š Good)"},"suggestions":{"1","2","3","4","5","6","7","8","9","10"}};
		response.put("questions",{question});
		return response;
	}
	// ---------------- Daily Affirmations (Supabase via Connection) ----------------
	else if(ans.equalsIgnoreCase("Daily Affirmations"))
	{
		if(answers.containsKey("affirm_select"))
		{
			backTxt = ifnull(answers.get("affirm_select").get("text"),"").toLowerCase();
			if(backTxt.contains("back"))
			{
				resp = Map();
				resp.put("action","context");
				resp.put("context_id","mindcheck_menu");
				q = {"name":"mind_option","replies":{"Let's explore your **Mind Wellness** ğŸ˜Š"},"suggestions":{"Mood Check","Daily Affirmations","Journaling Prompts","Back"}};
				resp.put("questions",{q});
				return resp;
			}
		}
		url = "https://sgkucjwmpwqewpdgjocq.supabase.co/functions/v1/ai-chat";
		payload = Map();
		payload.put("message","Generate a daily affirmation in one sentence. It must be positive, encouraging, and short.");
		payload.put("mood_rating",5);
		headerMap = Map();
		headerMap.put("Content-Type","application/json");
		try 
		{
			apiResponse = invokeurl
			[
				url :url
				type :POST
				parameters:payload.toString()
				headers:headerMap
				connection:"supabase_thera_ai"
			];
			botReply = ifnull(apiResponse.get("response"),"Sorry â€” no response from affirmation API.");
			question = {"name":"affirm_select","replies":{botReply},"suggestions":{"Back"}};
			respMap = Map();
			respMap.put("action","context");
			respMap.put("context_id","mindcheck_menu");
			respMap.put("questions",{question});
			return respMap;
		}
		catch (e)
		{
			errText = "Affirmation API Error: " + e.toString();
			question = {"name":"affirm_select","replies":{errText},"suggestions":{"Back"}};
			respErr = Map();
			respErr.put("action","context");
			respErr.put("context_id","mindcheck_menu");
			respErr.put("questions",{question});
			return respErr;
		}
	}
	// ---------------- Journaling Prompts (Supabase via Connection) ----------------
	else if(ans.equalsIgnoreCase("Journaling Prompts"))
	{
		if(answers.containsKey("journal_select"))
		{
			backTxt = ifnull(answers.get("journal_select").get("text"),"").toLowerCase();
			if(backTxt.contains("back"))
			{
				resp = Map();
				resp.put("action","context");
				resp.put("context_id","mindcheck_menu");
				q = {"name":"mind_option","replies":{"Let's explore your **Mind Wellness** ğŸ˜Š"},"suggestions":{"Mood Check","Daily Affirmations","Journaling Prompts","Back"}};
				resp.put("questions",{q});
				return resp;
			}
		}
		url = "https://sgkucjwmpwqewpdgjocq.supabase.co/functions/v1/ai-chat";
		payload = Map();
		payload.put("message","Generate a reflective journaling prompt. It must be simple, clear, and help self-awareness.");
		payload.put("mood_rating",5);
		headerMap = Map();
		headerMap.put("Content-Type","application/json");
		try 
		{
			apiResponse = invokeurl
			[
				url :url
				type :POST
				parameters:payload.toString()
				headers:headerMap
				connection:"supabase_thera_ai"
			];
			botReply = ifnull(apiResponse.get("response"),"Sorry â€” no response from journaling API.");
			question = {"name":"journal_select","replies":{botReply},"suggestions":{"Back"}};
			respMap = Map();
			respMap.put("action","context");
			respMap.put("context_id","mindcheck_menu");
			respMap.put("questions",{question});
			return respMap;
		}
		catch (e)
		{
			errText = "Journaling API Error: " + e.toString();
			question = {"name":"journal_select","replies":{errText},"suggestions":{"Back"}};
			respErr = Map();
			respErr.put("action","context");
			respErr.put("context_id","mindcheck_menu");
			respErr.put("questions",{question});
			return respErr;
		}
	}
	else if(ans.equalsIgnoreCase("Back"))
	{
		response.put("action","context");
		response.put("context_id","care_main");
		q = {"name":"care_main","replies":{"ğŸ©º Welcome to *MedKit Wellness Hub*!"},"suggestions":{"Child Care ğŸ‘¶","Glow Care âœ¨","Health Care ğŸ©º","ğŸ§  Mind Care","Weather Care ğŸ˜·","Main Menu"}};
		response.put("questions",{q});
		return response;
	}
	else
	{
		resp = Map();
		resp.put("action","context");
		resp.put("context_id","mindcheck_menu");
		q = {"name":"mind_option","replies":{"Let's explore your **Mind Wellness** ğŸ˜Š"},"suggestions":{"Mood Check","Daily Affirmations","Journaling Prompts","Back"}};
		resp.put("questions",{q});
		return resp;
	}
}
if(context_id != null && context_id.equals("mind_mood_check"))
{
	if(answers != null && answers.containsKey("mood_select"))
	{
		backTxt = ifnull(answers.get("mood_select").get("text"),"");
		backTxt = backTxt.toLowerCase();
		backTxt = backTxt.trim();
		if(backTxt.contains("back"))
		{
			resp = Map();
			resp.put("action","context");
			resp.put("context_id","mindcheck_menu");
			q = {"name":"mind_option","replies":{"Let's explore your **Mind Wellness** ğŸ˜Š"},"suggestions":{"Mood Check","Daily Affirmations","Journaling Prompts","Back"}};
			resp.put("questions",{q});
			return resp;
		}
	}
	userMood = "5";
	if(answers != null && answers.containsKey("mood_rating"))
	{
		tmp = ifnull(answers.get("mood_rating").get("text"),"5");
		tmp = tmp.toLowerCase();
		tmp = tmp.trim();
		// if typed "back" in rating input
		if(tmp.contains("back"))
		{
			resp = Map();
			resp.put("action","context");
			resp.put("context_id","mindcheck_menu");
			q = {"name":"mind_option","replies":{"Let's explore your **Mind Wellness** ğŸ˜Š"},"suggestions":{"Mood Check","Daily Affirmations","Journaling Prompts","Back"}};
			resp.put("questions",{q});
			return resp;
		}
		userMood = tmp;
	}
	url = "https://sgkucjwmpwqewpdgjocq.supabase.co/functions/v1/ai-chat";
	payload = Map();
	try 
	{
		mr = userMood.toLong();
	}
	catch (e)
	{
		mr = 5;
	}
	payload.put("message","Respond based on the user's mood rating using: 1â€“4 = low, 5â€“7 neutral, 8â€“10 good.");
	payload.put("mood_rating",mr);
	headerMap = Map();
	headerMap.put("Content-Type","application/json");
	try 
	{
		apiResponse = invokeurl
		[
			url :url
			type :POST
			parameters:payload.toString()
			headers:headerMap
			connection:"supabase_thera_ai"
		];
		botReply = ifnull(apiResponse.get("response"),"Sorry â€” no response from journaling API.");
		question = {"name":"mood_select","replies":{botReply},"suggestions":{"Back"}};
		resp = Map();
		resp.put("action","context");
		resp.put("context_id","mindcheck_menu");
		resp.put("questions",{question});
		return resp;
	}
	catch (e)
	{
		question = {"name":"mood_select","replies":{"Oops! Unable to connect ğŸ˜”"},"suggestions":{"Back"}};
		resp = Map();
		resp.put("action","context");
		resp.put("context_id","mindcheck_menu");
		resp.put("questions",{question});
		return resp;
	}
}
if(context_id != null && context_id.equals("tablet_info"))
{
	response = Map();
	trigger = "";
	if(answers.containsKey("tablet_trigger"))
	{
		trigger = ifnull(answers.get("tablet_trigger").get("text"),"").toLowerCase().trim();
	}
	if(trigger.contains("back"))
	{
		response = Map();
		response.put("action","context");
		response.put("context_id","health_hub");
		q = {"name":"health_hub","replies":{"Welcome to **Health Hub** ğŸ©º! Choose an option:"},"suggestions":{"ğŸ” Search Hospitals","Tablet Info ğŸ’Š","ğŸ“ Emergency Contacts","Health News ğŸ“°","Back"}};
		response.put("questions",{q});
		return response;
	}
	if(trigger.contains("search again") || trigger.contains("search") && !trigger.contains("hospital"))
	{
		question = {"name":"tablet_name","replies":{"Please enter the **Tablet Name** you want information about (e.g., Paracetamol)."},"input":{"type":"name","placeholder":"Eg. Paracetamol, Ibuprofen","value":"","error":{"Enter a valid tablet name"}},"suggestions":{"Main Menu","Search Hospitals","Back"}};
		response.put("action","context");
		response.put("context_id","tablet_info");
		response.put("questions",{question});
		return response;
	}
	if(trigger.contains("hospital"))
	{
		response.put("action","context");
		response.put("context_id","search_hospitals");
		question = {"name":"city_name","replies":{"Please enter the **City Name** where you want to find hospitals (e.g., Madurai)."},"input":{"type":"name","placeholder":"Eg. Madurai, Chennai, Mumbai...","value":"","error":{"Enter a valid city name"}},"suggestions":{"Main Menu","Back"}};
		response.put("questions",{question});
		return response;
	}
	if(trigger.contains("main menu"))
	{
		response.put("action","context");
		response.put("context_id","mainmenu");
		question = {"name":"select","replies":{"Hey buddy ğŸ™‹â€â™‚ï¸ Welcome to **MedKit** ğŸ©º! I'm here to guide you. Tell me what you'd like to do!"},"suggestions":{"MedKit Wellness Hub ğŸŒ¿","ğŸ‹ï¸ FitZone","ProcureX ğŸ›’","ğŸ’¬ Motivational Boost","ğŸ¤ Consult an Expert","ğŸ“ Help Desk"}};
		response.put("questions",{question});
		return response;
	}
	tabname = "";
	if(answers.containsKey("tablet_name"))
	{
		tabname = ifnull(answers.get("tablet_name").get("text"),"").trim();
	}
	if(tabname == "")
	{
		question = {"name":"tablet_name","replies":{"Please enter a valid **Medicine or Tablet Name.**"},"input":{"type":"name","placeholder":"Eg. Paracetamol, Ibuprofen","value":"","error":{"Enter a valid tablet name"}},"suggestions":{"Main Menu","Search Hospitals"}};
		response.put("action","context");
		response.put("context_id","tablet_info");
		response.put("questions",{question});
		return response;
	}
	wiki_url = "https://en.wikipedia.org/api/rest_v1/page/summary/" + tabname.replaceAll(" ","%20");
	summary = "";
	desc = "";
	try 
	{
		wikiResp = invokeurl
		[
			url :wiki_url
			type :GET
		];
		summary = wikiResp.get("extract");
		if(summary == null || summary == "" || summary == "null")
		{
			summary = "";
		}
	}
	catch (ex)
	{
		summary = "";
	}
	if(summary != "")
	{
		desc = summary;
	}
	else
	{
		desc = "âš ï¸ No detailed information found for **" + tabname + "** right now.";
	}
	finalText = "ğŸ’Š *Medicine Information for*: **" + tabname + "**\n\n" + desc;
	question = {"name":"tablet_trigger","replies":{finalText},"suggestions":{"Search Hospitals","Main Menu","Back"}};
	response.put("action","context");
	response.put("context_id","tablet_info");
	response.put("questions",{question});
	return response;
}
if(context_id != null && context_id.equals("search_hospitals"))
{
	raw_trim = ifnull(answers.get("city_name").get("text"),"").trim();
	city_trim = raw_trim;
	city_no_spaces = city_trim.replaceAll(" ","");
	alpha_only = "";
	try 
	{
		alpha_only = city_no_spaces.getAlpha();
	}
	catch (exv)
	{
		alpha_only = "";
	}
	if(city_trim.equals("") || city_trim.length() == 0 || !alpha_only.equals(city_no_spaces))
	{
		response.put("action","context");
		response.put("context_id","search_hospitals");
		q = Map();
		q.put("name","city_name");
		q.put("replies",{"âš ï¸ Please enter a valid **City Name** using *letters only* (e.g., Chennai). ğŸ™ï¸"});
		q.put("suggestions",{"Search","Main Menu","Back"});
		response.put("questions",{q});
		return response;
	}
	city_enc = city_trim.replaceAll(" ","%20");
	url_str = "https://nominatim.openstreetmap.org/search?format=json&city=" + city_enc + "&amenity=hospital&limit=10";
	apiResp = List();
	results = List();
	try 
	{
		apiResp = invokeurl
		[
			url :url_str
			type :GET
		];
		try 
		{
			results = apiResp;
		}
		catch (re)
		{
			results = List();
		}
	}
	catch (apiErr)
	{
		results = List();
	}
	if(results.size() == 0)
	{
		response.put("action","context");
		response.put("context_id","health_hub");
		q = Map();
		q.put("name","health_hub");
		q.put("replies",{"Sorry â€” couldn't find hospitals in " + city_trim + "."});
		q.put("suggestions",{"Search Another","Main Menu","Back"});
		response.put("questions",{q});
		return response;
	}
	cards = List();
	idx = 0;
	for each  r in results
	{
		if(idx < 2)
		{
			name = "";
			display = "";
			lat = "";
			lon = "";
			try 
			{
				if(r.get("name") != null)
				{
					name = "" + r.get("name");
				}
			}
			catch (ex1)
			{
				name = "";
			}
			try 
			{
				if(r.get("display_name") != null)
				{
					display = "" + r.get("display_name");
				}
			}
			catch (ex2)
			{
				display = "";
			}
			try 
			{
				if(r.get("lat") != null)
				{
					lat = "" + r.get("lat");
				}
			}
			catch (ex3)
			{
				lat = "";
			}
			try 
			{
				if(r.get("lon") != null)
				{
					lon = "" + r.get("lon");
				}
			}
			catch (ex4)
			{
				lon = "";
			}
			if(name.equals("") && !display.equals(""))
			{
				try 
				{
					commaPos = display.indexOf(",");
					if(commaPos > -1)
					{
						name = display.substring(0,commaPos);
					}
					else
					{
						name = display;
					}
				}
				catch (ex5)
				{
					name = display;
				}
			}
			osmLink = "";
			try 
			{
				if(lat != "" && lon != "")
				{
					osmLink = "https://www.openstreetmap.org/?mlat=" + lat + "&mlon=" + lon + "#map=18/" + lat + "/" + lon;
				}
				else
				{
					osmLink = "https://www.openstreetmap.org/search?query=" + name.replaceAll(" ","%20") + "%20" + city_enc;
				}
			}
			catch (ex6)
			{
				osmLink = "https://www.openstreetmap.org/search?query=" + name.replaceAll(" ","%20") + "%20" + city_enc;
			}
			try 
			{
				googleMapsSearch = "https://www.google.com/search?q=" + name.replaceAll(" ","%20") + "%20" + city_enc;
			}
			catch (ex7)
			{
				googleMapsSearch = "https://www.google.com/search?q=" + name.replaceAll(" ","%20");
			}
			card = Map();
			cardText = "";
			if(!display.equals(""))
			{
				if(name.equals(""))
				{
					cardText = "Hospital Â· " + display;
				}
				else
				{
					cardText = name + " Â· " + display;
				}
			}
			else
			{
				if(name.equals(""))
				{
					cardText = "Hospital";
				}
				else
				{
					cardText = name;
				}
			}
			card.put("type","links");
			card.put("text",cardText);
			card.put("image","");
			card.put("image_position","fit");
			linksList = List();
			l1 = Map();
			l1.put("url",osmLink);
			l1.put("text","Open in Maps");
			l1.put("icon","https://cdn-icons-png.flaticon.com/512/854/854878.png");
			linksList.add(l1);
			l2 = Map();
			l2.put("url",googleMapsSearch);
			l2.put("text","More Info");
			l2.put("icon","https://cdn-icons-png.flaticon.com/512/9018/9018732.png");
			linksList.add(l2);
			card.put("links",linksList);
			cards.add(card);
		}
		idx = idx + 1;
	}
	response.put("action","context");
	response.put("context_id","health_hub");
	q = Map();
	q.put("name","health_hub");
	q.put("replies",cards);
	sugList = List();
	sugList.add("Search More");
	sugList.add("Back");
	q.put("suggestions",sugList);
	response.put("questions",{q});
	return response;
}
if(context_id != null && context_id == "baby_nutri")
{
	nutr_trigger = "";
	if(answers.containsKey("nutriselect"))
	{
		nutr_trigger = ifnull(answers.get("nutriselect").get("text"),"").toLowerCase();
	}
	if(nutr_trigger.contains("back") || nutr_trigger.contains("main"))
	{
		response.put("action","context");
		response.put("context_id","child_menu");
		q = {"name":"child_menu","replies":{"ğŸ‘¶ *Child Care & Parenting Guide*"},"suggestions":{"ğŸ¼ Baby Nutrition","ğŸ’‰ Vaccine Guide","ğŸ§¸ Child Safety","Back"}};
		response.put("questions",{q});
		return response;
	}
	food = ifnull(answers.get("food_name").get("text"),"").trim();
	if(food == "")
	{
		resp = Map();
		resp.put("action","context");
		resp.put("context_id","baby_nutri");
		q = {"name":"food_name","replies":{"Please enter a **Food Name** ğŸ˜Š"},"suggestions":{"Main Menu","Back"}};
		resp.put("questions",{q});
		return resp;
	}
	nutriText = "";
	try 
	{
		apiResp = invokeurl
		[
			url :"https://api.api-ninjas.com/v1/nutrition?query=" + encodeUrl(food)
			type :GET
			connection:"apininjas_nutri_conn"
		];
		if(apiResp != null && apiResp.size() > 0)
		{
			item = apiResp.get(0);
			nutriText = "ğŸ *Nutrition for* **" + food.toUpperCase() + "**\n" + "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n" + "ğŸ¥‘ **Fat:** " + item.get("fat_total_g") + " g\n" + "ğŸ **Carbohydrates:** " + item.get("carbohydrates_total_g") + " g\n" + "ğŸŒ¾ **Fiber:** " + item.get("fiber_g") + " g\n" + "ğŸ¬ **Sugar:** " + item.get("sugar_g") + " g\n" + "ğŸ§‚ **Sodium:** " + item.get("sodium_mg") + " mg\n" + "ğŸŒ **Potassium:** " + item.get("potassium_mg") + " mg\n" + "ğŸ©¸ **Cholesterol:** " + item.get("cholesterol_mg") + " mg\n\n" + "âš ï¸ _Always consult a **pediatrician** before introducing new foods to babies._";
		}
		else
		{
			nutriText = "âš ï¸ No nutrition data found. Try a simpler food name.";
		}
	}
	catch (e)
	{
		nutriText = "âš ï¸ Could not fetch nutrition info. Try again later.";
	}
	question = {"name":"nutriselect","replies":{nutriText},"suggestions":{"Back"}};
	respMap = Map();
	respMap.put("action","context");
	respMap.put("context_id","baby_nutri");
	respMap.put("questions",{question});
	return respMap;
}
if(context_id != null && context_id.equals("skin_menu"))
{
	if(answers != null)
	{
		keysList = answers.keys();
		for each  k in keysList
		{
			backTxt = ifnull(answers.get(k).get("text"),"");
			backTxt = backTxt.toLowerCase();
			backTxt = backTxt.trim();
			if(backTxt.contains("back"))
			{
				response = Map();
				response.put("action","context");
				response.put("context_id","care_main");
				q = {"name":"care_main","replies":{"ğŸ©º Welcome to *MedKit Wellness Hub*!"},"suggestions":{"Child Care ğŸ‘¶","Glow Care âœ¨","Health Care ğŸ©º","ğŸ§  Mind Care","Weather Care ğŸ˜·","Main Menu"}};
				response.put("questions",{q});
			}
		}
	}
	// ---------- Normal Skin Care Tips flow ----------
	opt = ifnull(answers.get("skin_menu").get("text"),"");
	if(opt.containsIgnoreCase("Skin Care Tips"))
	{
		// ---------- SIMPLE BACK HANDLER ----------
		if(answers != null && answers.containsKey("skin_select"))
		{
			backTxt = ifnull(answers.get("skin_select").get("text"),"");
			backTxt = backTxt.toLowerCase();
			backTxt = backTxt.trim();
			if(backTxt.contains("back"))
			{
				resp = Map();
				resp.put("action","context");
				resp.put("context_id","skin_menu");
				q = {"name":"skin_menu","replies":{"âœ¨ Welcome to **Glow Care** â€” your personal skin & hair wellness guide!"},"suggestions":{"âœ¨ Skin Care Tips","ğŸ’‡â€â™€ï¸ Hair Checkup","ğŸ§´ Medzon Products","Back"}};
				resp.put("questions",{q});
				return resp;
			}
		}
		// ---------- NORMAL SKIN CARE TIPS FLOW ----------
		response = Map();
		response.put("action","context");
		response.put("context_id","skin_menu");
		query = "simple skin care routine for glowing skin";
		params = Map();
		params.put("part","snippet");
		params.put("type","video");
		params.put("maxResults","2");
		params.put("q",query);
		ytResp = invokeurl
		[
			url :"https://www.googleapis.com/youtube/v3/search"
			type :GET
			parameters:params
			connection:"youtube"
		];
		if(ytResp == null || ytResp.get("items") == null)
		{
			question = Map();
			question.put("name","skin_select");
			question.put("replies",{"Sorry â€” couldn't fetch *skin care videos* right now. Please try again later."});
			question.put("suggestions",{"Back","Main Menu"});
			response.put("questions",{question});
			return response;
		}
		items = ytResp.get("items");
		videoCards = List();
		if(items != null && items.size() > 0)
		{
			for each  itm in items
			{
				if(itm != null)
				{
					vid = "";
					title = "Skin Care Video";
					idObj = itm.get("id");
					if(idObj != null && idObj.get("videoId") != null)
					{
						vid = "" + idObj.get("videoId");
					}
					snippet = itm.get("snippet");
					if(snippet != null && snippet.get("title") != null)
					{
						title = "" + snippet.get("title");
					}
					if(vid != null && vid != "")
					{
						vmap = Map();
						vmap.put("type","video");
						vmap.put("text",title);
						vmap.put("url","https://www.youtube.com/watch?v=" + vid);
						videoCards.add(vmap);
					}
				}
			}
		}
		if(videoCards.size() == 0)
		{
			fb1 = Map();
			fb1.put("type","video");
			fb1.put("text","Basic Daily Skin Care Routine");
			fb1.put("url","https://www.youtube.com/watch?v=VIDEO_ID_1");
			fb2 = Map();
			fb2.put("type","video");
			fb2.put("text","Dermatologist Skin Care Tips");
			fb2.put("url","https://www.youtube.com/watch?v=VIDEO_ID_2");
			videoCards.add(fb1);
			videoCards.add(fb2);
		}
		replies = List();
		replies.add("âœ¨ *Here are some helpful skin care videos:*");
		for each  v in videoCards
		{
			replies.add(v);
		}
		question = Map();
		question.put("name","skin_select");
		question.put("replies",replies);
		question.put("suggestions",{"Back"});
		response.put("questions",{question});
		return response;
	}
	else if(opt.containsIgnoreCase("Medzon"))
	{
		if(answers.containsKey("medzon_select"))
		{
			backTxt = ifnull(answers.get("medzon_select").get("text"),"").toLowerCase();
			if(backTxt.contains("back"))
			{
				resp = Map();
				resp.put("action","context");
				resp.put("context_id","skin_menu");
				q = {"name":"skin_menu","replies":{"âœ¨ Welcome to **Glow Care** â€” your personal skin & hair wellness guide!"},"suggestions":{"âœ¨ Skin Care Tips","ğŸ’‡â€â™€ï¸ Hair Checkup","ğŸ§´ Medzon Products","Back"}};
				resp.put("questions",{q});
				return resp;
			}
		}
		products = List();
		product1 = {"type":"links","text":"**Sunscreen SPF 50 â€“ Oil Free\n\nPrice: â‚¹443**\nLightweight, non-greasy sunscreen for daily use.","image":"https://m.media-amazon.com/images/I/61GWPBUra2L._AC_UF1000%2C1000_QL80_.jpg","image_position":"fit","links":{{"url":"https://amzn.in/d/fJxHirT","text":"Buy Now","icon":"https://image.flaticon.com/icons/png/512/126/126083.png"}}};
		products.add(product1);
		product2 = {"type":"links","text":"**Hydrating Face Moisturizer\n\nPrice: â‚¹321**\nFor normal to dry skin. Keeps skin soft & hydrated.","image":"https://images.squarespace-cdn.com/content/v1/5c4f6ba1e2ccd1ee6075495d/6ef9ea24-eecf-468e-a82d-66fa6abe1e17/skincare-routine-order.jpg","image_position":"fit","links":{{"url":"https://amzn.in/d/1DzzJTO","text":"Buy Now","icon":"https://image.flaticon.com/icons/png/512/126/126083.png"}}};
		products.add(product2);
		product3 = {"type":"links","text":"**Anti Hair Fall Shampoo\n\nPrice: â‚¹449**\nStrengthens hair and helps reduce breakage.","image":"https://innovist.com/cdn/shop/files/1_6_bcfc8add-ea04-48e6-ba75-d1529df79936.jpg?v=1760077719","image_position":"fit","links":{{"url":"https://amzn.in/d/giinGdw","text":"Buy Now","icon":"https://image.flaticon.com/icons/png/512/126/126083.png"}}};
		products.add(product3);
		replies = List();
		replies.add("ğŸ§´ *Medzon â€“ Skin & Hair Products*");
		replies.add("Here are some useful products for your skin & hair:");
		for each  p in products
		{
			replies.add(p);
		}
		question = {"name":"medzon_select","replies":replies,"suggestions":{"Back"}};
		respMap = Map();
		respMap.put("action","context");
		respMap.put("context_id","skin_menu");
		// keep user in skin_menu context so Back works naturally
		respMap.put("questions",{question});
		return respMap;
	}
	else if(opt.containsIgnoreCase("Hair Checkup"))
	{
		response.put("action","context");
		response.put("context_id","hair_checkup");
		q = {"name":"hair_wash_count","replies":{"ğŸ’‡â€â™€ï¸ *Hair Wash Checkup*","How many times do you wash your hair per week? (0â€“14)"},"input":{"type":"name","placeholder":"Eg. 2"}};
		response.put("questions",{q});
		return response;
	}
	else if(opt.containsIgnoreCase("Back"))
	{
		response.put("action","context");
		response.put("context_id","care_main");
		q = {"name":"care_main","replies":{"ğŸ©º Welcome to *MedKit Wellness Hub*!"},"suggestions":{"Child Care ğŸ‘¶","Glow Care âœ¨","Health Care ğŸ©º","ğŸ§  Mind Care","Weather Care ğŸ˜·","Main Menu"}};
		response.put("questions",{q});
		return response;
	}
	else
	{
		response.put("action","context");
		response.put("context_id","skin_menu");
		q = {"name":"skin_menu","replies":{"âœ¨ Welcome to Glow Care â€” your personal skin & hair wellness guide!"},"suggestions":{"âœ¨ Skin Care Tips","ğŸ’‡â€â™€ï¸ Hair Checkup","ğŸ§´ Medzon Products","Back"}};
		response.put("questions",{q});
		return response;
	}
}
if(context_id != null && context_id.equals("hair_checkup"))
{
	resp = Map();
	washText = "";
	if(answers.containsKey("hair_wash_count"))
	{
		washText = ifnull(answers.get("hair_wash_count").get("text"),"").trim().toLowerCase();
	}
	if(washText.contains("back") || washText.contains("main"))
	{
		response.put("action","context");
		response.put("context_id","skin_menu");
		q = {"name":"skin_menu","replies":{"âœ¨ Welcome to **Glow Care** â€” your personal skin & hair wellness guide!"},"suggestions":{"âœ¨ Skin Care Tips","ğŸ’‡â€â™€ï¸ Hair Checkup","ğŸ§´ Medzon Products","Back"}};
		response.put("questions",{q});
		return response;
	}
	isValid = true;
	washCountNum = 0;
	try 
	{
		washCountNum = washText.toLong();
	}
	catch (e)
	{
		isValid = false;
	}
	if(!isValid || washCountNum < 0 || washCountNum > 14)
	{
		q = {"name":"hair_wash_count","replies":{"Please **Enter a Number** between *0 and 14* only ğŸ™‚","How many times do you wash your hair per week?"},"input":{"type":"name","placeholder":"Eg. 3"},"suggestions":{"Back"}};
		resp.put("action","context");
		resp.put("context_id","hair_checkup");
		resp.put("questions",{q});
		return resp;
	}
	msg = "";
	if(washCountNum == 0)
	{
		msg = "ğŸ˜¬ Not washing at all can cause oil, sweat and dandruff build-up.\n\n" + "âœ… *Try this:*\nâ€¢ Wash at least 2 times per week.\nâ€¢ Use mild shampoo.\nâ€¢ Oil 1â€“2 hours before wash.";
	}
	else if(washCountNum == 1 || washCountNum == 2)
	{
		msg = "ğŸŒ¿ Good for *dry or normal hair*.\n\n" + "âœ… *Tips:*\nâ€¢ Oil once or twice weekly.\nâ€¢ Use lukewarm water.\nâ€¢ Massage scalp gently.";
	}
	else if(washCountNum == 3 || washCountNum == 4)
	{
		msg = "ğŸ‘Œ *Ideal balance* for most hair types.\n\n" + "âœ… *Maintain:*\nâ€¢ Mild shampoo.\nâ€¢ Conditioner only on ends.\nâ€¢ Oil 1â€“2 times weekly.";
	}
	else if(washCountNum >= 5 && washCountNum <= 7)
	{
		msg = "âš ï¸ You may be *washing too frequently*.\n\n" + "Too much washing â†’ dryness & frizz.\n\n" + "âœ… *Try this:*\nâ€¢ Reduce to 3â€“4 times weekly.\nâ€¢ Baby shampoo.\nâ€¢ Light serum on ends.";
	}
	else if(washCountNum > 7)
	{
		msg = "ğŸš¨ *Over-washing alert!*\n\n" + "Daily washing strips natural oils â†’ dryness + hair fall.\n\n" + "âœ… *Do this:*\nâ€¢ Reduce frequency slowly.\nâ€¢ Sulfate-free shampoo.\nâ€¢ Oil before wash.\nâ€¢ Avoid hot water.";
	}
	msg = msg + "\n\nğŸ§´ *General Healthy Hair Tips:*\nâ€¢ Comb gently.\nâ€¢ Eat protein-rich foods.\nâ€¢ Drink water.\nâ€¢ Sleep well.";
	question = {"name":"hair_wash_count","replies":{msg},"suggestions":{"Back"}};
	resp.put("action","context");
	resp.put("context_id","hair_checkup");
	resp.put("questions",{question});
	return resp;
}
if(context_id != null && context_id.equals("weather_care"))
{
	if(answers.containsKey("weatherselect"))
	{
		backText = ifnull(answers.get("weatherselect").get("text"),"").toLowerCase();
		if(backText.contains("back"))
		{
			resp = Map();
			resp.put("action","context");
			resp.put("context_id","care_main");
			q = {"name":"care_main","replies":{"ğŸ©º Welcome to *MedKit Wellness Hub*!"},"suggestions":{"Child Care ğŸ‘¶","Glow Care âœ¨","Health Care ğŸ©º","ğŸ§  Mind Care","Weather Care ğŸ˜·","Main Menu"}};
			resp.put("questions",{q});
			return resp;
		}
	}
	if(!answers.containsKey("location"))
	{
		response.put("action","context");
		response.put("context_id","weather_care");
		q = {"name":"location","replies":{"ğŸŒ¦ï¸ *Weather Health Tips*","To give accurate advice, please share your location."},"input":{"type":"location","radius":"2 kms","label":"Share my location","select_label":"Send my location"}};
		response.put("questions",{q});
		return response;
	}
	locMap = answers.get("location");
	addr = ifnull(locMap.get("text"),"");
	cityName = "";
	OPENWEATHER_GEO_URL = "https://api.openweathermap.org/geo/1.0/direct";
	OPENWEATHER_WEATHER_URL = "https://api.openweathermap.org/data/2.5/weather";
	OPENWEATHER_AIR_URL = "https://api.openweathermap.org/data/2.5/air_pollution";
	if(addr != "")
	{
		parts = addr.toList(",");
		if(parts.size() > 0)
		{
			cityName = parts.get(0).trim();
		}
	}
	if(cityName == "" && addr != "")
	{
		words = addr.toList(" ");
		for each  w in words
		{
			if(w.matches("\\d{6}"))
			{
				cityName = w;
			}
		}
	}
	if(cityName == "")
	{
		response.put("action","context");
		response.put("context_id","weather_care");
		q = {"name":"location","replies":{"âš ï¸ I couldnâ€™t read your location properly.","Please share it again so I can check nearby weather and air quality."},"input":{"type":"location","radius":"2 kms","label":"Share my location","select_label":"Send my location"}};
		response.put("questions",{q});
		return response;
	}
	try 
	{
		geoUrl = OPENWEATHER_GEO_URL + "?q=" + encodeUrl(cityName) + "&limit=1";
		geoResp = invokeurl
		[
			url :geoUrl
			type :GET
			connection:"openweather_salesiq"
		];
		if(geoResp == null || geoResp.size() == 0)
		{
			question = {"name":"weatherselect","replies":{"âš ï¸ I couldnâ€™t find weather info for `" + cityName + "`.","Please try again later."},"suggestions":{"Back"}};
			resp = Map();
			resp.put("action","context");
			resp.put("context_id","weather_care");
			resp.put("questions",{question});
			return resp;
		}
		g0 = geoResp.get(0);
		lat = g0.get("lat");
		lon = g0.get("lon");
		latStr = "" + lat;
		lonStr = "" + lon;
		wUrl = OPENWEATHER_WEATHER_URL + "?lat=" + latStr + "&lon=" + lonStr + "&units=metric";
		wResp = invokeurl
		[
			url :wUrl
			type :GET
			connection:"openweather_salesiq"
		];
		main = wResp.get("main");
		weatherAr = wResp.get("weather");
		temp = ifnull(main.get("temp"),"");
		desc = "";
		if(weatherAr != null && weatherAr.size() > 0)
		{
			w0 = weatherAr.get(0);
			desc = ifnull(w0.get("description"),"");
		}
		aUrl = OPENWEATHER_AIR_URL + "?lat=" + latStr + "&lon=" + lonStr;
		aResp = invokeurl
		[
			url :aUrl
			type :GET
			connection:"openweather_salesiq"
		];
		aqiText = "Not available";
		healthTips = "General conditions look okay. Normal outdoor activity is fine.";
		if(aResp.containsKey("list"))
		{
			listA = aResp.get("list");
			if(listA != null && listA.size() > 0)
			{
				mainA = listA.get(0).get("main");
				aqi = mainA.get("aqi");
				if(aqi == 1)
				{
					aqiText = "Good";
					healthTips = "Air looks clean. Elders & kids can go out normally.";
				}
				else if(aqi == 2)
				{
					aqiText = "Fair";
					healthTips = "Okay for most. Asthma patients keep inhaler ready.";
				}
				else if(aqi == 3)
				{
					aqiText = "Moderate";
					healthTips = "Avoid long outdoor exposure for kids/elders.";
				}
				else if(aqi == 4)
				{
					aqiText = "Poor";
					healthTips = "Limit outdoor activity. Light mask recommended.";
				}
				else if(aqi == 5)
				{
					aqiText = "Very Poor";
					healthTips = "Avoid going outside, close windows near roadside.";
				}
			}
		}
		replyTxt = "ğŸŒ¦ï¸ Weather health tips for `" + cityName + "`\n\n";
		if(temp != "")
		{
			replyTxt = replyTxt + "â€¢ Temperature: " + temp + "Â°C\n";
		}
		if(desc != "")
		{
			replyTxt = replyTxt + "â€¢ Condition: " + desc + "\n";
		}
		replyTxt = replyTxt + "â€¢ Air quality: " + aqiText + "\n\n";
		replyTxt = replyTxt + "ğŸ‘¨â€âš•ï¸ Advice: " + healthTips + "\n\n";
		replyTxt = replyTxt + "_This is general advice only. Consult a doctor for medical issues._";
		question = {"name":"weatherselect","replies":{replyTxt},"suggestions":{"Back"}};
		respMap = Map();
		respMap.put("action","context");
		respMap.put("context_id","weather_care");
		respMap.put("questions",{question});
		return respMap;
	}
	catch (e)
	{
		question = {"name":"weatherselect","replies":{"âš ï¸ Unable to fetch weather.","Please try again later."},"suggestions":{"Back"}};
		resp = Map();
		resp.put("action","context");
		resp.put("context_id","weather_care");
		resp.put("questions",{question});
		return resp;
	}
}
// ----------------------------------------------------------------------------------------
// procurex Context Handler
portalId = "trycatchus";
if(context_id != null && context_id.equals("procurex"))
{
	trig = "";
	trigLower = "";
	if(answers.containsKey("procurex"))
	{
		trig = ifnull(answers.get("procurex").get("text"),"");
		trigLower = trig.toLowerCase();
	}
	nfNeedPaymentId = false;
	try 
	{
		pidFlagResp = zoho.salesiq.visitorsession.get(portalId,"nf_need_payment_id");
		if(pidFlagResp.containsKey("data"))
		{
			nfNeedPaymentId = ifnull(pidFlagResp.get("data").get("nf_need_payment_id"),false);
		}
	}
	catch (e)
	{
		nfNeedPaymentId = false;
	}
	usedPayments = List();
	try 
	{
		usedResp = zoho.salesiq.visitorsession.get(portalId,"nf_used_payments");
		if(usedResp.containsKey("data"))
		{
			dataMap = usedResp.get("data");
			if(dataMap.containsKey("nf_used_payments"))
			{
				usedPayments = ifnull(dataMap.get("nf_used_payments"),List());
			}
		}
	}
	catch (e)
	{
		usedPayments = List();
	}
	if(trigLower.equalsIgnoreCase("main menu") || trigLower.equalsIgnoreCase("mainmenu"))
	{
		response.put("action","context");
		response.put("context_id","mainmenu");
		question = {"name":"select","replies":{"Hey buddy ğŸ™‹â€â™‚ï¸ Welcome to **MedKit** ğŸ©º! I'm here to guide you. Tell me what you'd like to do!"},"suggestions":{"MedKit Wellness Hub ğŸŒ¿","ğŸ‹ï¸ FitZone","ProcureX ğŸ›’","ğŸ’¬ Motivational Boost","ğŸ¤ Consult an Expert","ğŸ“ Help Desk"}};
		response.put("questions",{question});
		return response;
	}
	if(trigLower.equalsIgnoreCase("Back") || trigLower.equalsIgnoreCase("back"))
	{
		response.put("action","context");
		response.put("context_id","procurex");
		question = {"name":"procurex","replies":{"Welcome to ProcureX ğŸ›’ â€” explore our **MedKit Premium Products ğŸ›ï¸** below:"},"suggestions":{"ğŸ›ï¸ MedKit Products","â„¹ï¸ About Purchasing","Main Menu"}};
		response.put("questions",{question});
		return response;
	}
	products = List();
	p1 = {"name":"NutriNet Nutrient Food Pack","price":"149","desc":"Premium protein pack for muscle growth, recovery, and overall wellness. **â‚¹149 only**","img":"https://enthusiastic-silver-vq9qiwjw3t.edgeone.app/NUTRINET.png"};
	products.add(p1);
	p2 = {"name":"NutriPlus Health Pack","price":"179","desc":"A complete daily health pack designed to boost immunity, energy, and overall wellness. **â‚¹179 only**","img":"https://gleaming-rose-f5xyflngmp.edgeone.app/NUTRIPLUS.png"};
	products.add(p2);
	p3 = {"name":"NutriDaily Food Pack","price":"129","desc":"Daily nutrition pack enriched with essential vitamins and omega-3 for heart, brain, and body wellness. **â‚¹129 only**","img":"https://local-green-vopfvrljj7.edgeone.app/NUTRIDAILY.png"};
	products.add(p3);
	p4 = {"name":"NutriBoost Nutrient Mix","price":"199","desc":"A nutrient-rich blend of soy protein isolate, whey concentrate, oats, seeds, cocoa, and natural flavors for powerful daily energy and performance. **â‚¹199 only**","img":"https://disappointed-olive-xhhlvxpevn.edgeone.app/NUTRIBOOST.png"};
	products.add(p4);
	p5 = {"name":"FitTrack Smart Band","price":"199","desc":"An all-in-one fitness tracker that monitors steps, distance, calories burned, heart rate, and sleep with a lightweight, waterproof design that syncs with iOS and Android devices.","img":"https://hidden-amber-fuzxfmcwwm.edgeone.app/FIT%20TRACK.png"};
	products.add(p5);
	p6 = {"name":"PowerPulse Resistance Kit","price":"149","desc":"A portable strength training set with five resistance bands of varying tension, ergonomic handles, a door anchor, and ankle straps for full-body workouts at home, the gym, or on the go.","img":"https://occupational-fuchsia-nv5xpyxci1.edgeone.app/POWERPULSE%20KIT.png"};
	products.add(p6);
	p7 = {"name":"FlexiBalance Yoga Kit","price":"189","desc":"A complete flexibility and yoga solution with a non-slip yoga mat, yoga block, strap, and a convenient carrying bag â€” perfect for beginners and advanced practitioners alike.","img":"https://unfortunate-emerald-q1zrzd7y7v.edgeone.app/YOGA%20MATE.png"};
	products.add(p7);
	p8 = {"name":"CoreBoost Smart Jump Rope","price":"119","desc":"A smart jump rope for cardio and endurance with adjustable length, ergonomic handles, and a smart counter for jumps and calories â€” ideal for indoor and outdoor workouts.","img":"https://main-moccasin-fazaf4v3yy.edgeone.app/JUMP%20ROPE.png"};
	products.add(p8);
	prodCount = products.size();
	if(answers.containsKey("nf_payment_id") && nfNeedPaymentId == true)
	{
		paymentId = ifnull(answers.get("nf_payment_id").get("text"),"").trim();
		sessClear = Map();
		sessClear.put("nf_need_payment_id",false);
		zoho.salesiq.visitorsession.set(portalId,sessClear);
		if(paymentId == "")
		{
			response.put("action","context");
			response.put("context_id","procurex");
			q = Map();
			q.put("name","nf_payment_id");
			q.put("replies",{"âŒ Payment ID cannot be empty.","Please enter the Payment ID shown on your Razorpay success screen (eg: Rjbv2T2r****)."});
			inputMap = Map();
			inputMap.put("type","name");
			inputMap.put("placeholder","Eg. Rjbv2T2******");
			q.put("input",inputMap);
			response.put("questions",{q});
			return response;
		}
		apiPaymentId = paymentId;
		if(!apiPaymentId.startsWith("pay_"))
		{
			apiPaymentId = "pay_" + apiPaymentId;
		}
		alreadyUsed = false;
		usedProductName = "";
		for each  used in usedPayments
		{
			uid = ifnull(used.get("id"),"");
			if(uid == apiPaymentId)
			{
				alreadyUsed = true;
				usedProductName = ifnull(used.get("product"),"");
				break;
			}
		}
		if(alreadyUsed == true)
		{
			response.put("action","context");
			response.put("context_id","procurex");
			msgList = List();
			if(usedProductName != "")
			{
				msgList.add("âš ï¸ This Payment ID has already been used for *" + usedProductName + "*.");
			}
			else
			{
				msgList.add("âš ï¸ This Payment ID has already been used for an order.");
			}
			msgList.add("One payment can be used for only one order. Please make a new payment using *Pay with Razorpay* for another product.");
			q = Map();
			q.put("name","procurex");
			q.put("replies",msgList);
			q.put("suggestions",{"Show Products","Main Menu"});
			response.put("questions",{q});
			return response;
		}
		uname = "Customer";
		uemail = "";
		if(answers.containsKey("nf_name"))
		{
			uname = ifnull(answers.get("nf_name").get("text"),"Customer");
		}
		if(answers.containsKey("nf_email"))
		{
			uemail = ifnull(answers.get("nf_email").get("text"),"");
		}
		prodIndex = 0;
		try 
		{
			idxResp = zoho.salesiq.visitorsession.get(portalId,"nf_product_index");
			if(idxResp.containsKey("data"))
			{
				prodIndex = ifnull(idxResp.get("data").get("nf_product_index"),0).toNumber();
			}
		}
		catch (e)
		{
			prodIndex = 0;
		}
		if(prodIndex < 0 || prodIndex >= prodCount)
		{
			prodIndex = 0;
		}
		prod = products.get(prodIndex);
		prodName = prod.get("name");
		prodPrice = prod.get("price");
		prodDesc = ifnull(prod.get("desc"),"");
		prodImg = ifnull(prod.get("img"),"");
		verified = false;
		payStatus = "";
		payAmount = 0;
		errorReason = "";
		expectedAmount = (prodPrice.toNumber() * 100).toLong();
		try 
		{
			verifyResp = invokeurl
			[
				url :"https://api.razorpay.com/v1/payments/" + apiPaymentId
				type :GET
				connection:"razorpay_test"
			];
			if(verifyResp.containsKey("error"))
			{
				errorReason = "This Payment ID is not found in Razorpay. Please check and enter the correct Payment ID from your Razorpay success page.";
			}
			else
			{
				payStatus = "" + verifyResp.get("status");
				payAmount = ifnull(verifyResp.get("amount"),0);
				// paise
				if(payStatus.equalsIgnoreCase("captured"))
				{
					if(payAmount == expectedAmount)
					{
						verified = true;
					}
					else
					{
						verified = false;
						errorReason = "This Payment ID is for â‚¹" + payAmount / 100 + ", but the selected product costs â‚¹" + prodPrice + ".";
					}
				}
				else
				{
					errorReason = "Payment status is '" + payStatus + "' for â‚¹" + payAmount / 100 + ".";
				}
			}
		}
		catch (e)
		{
			errorReason = "There was a problem while contacting Razorpay. Please try again in a minute.";
		}
		if(!verified)
		{
			response.put("action","context");
			response.put("context_id","procurex");
			msgList = List();
			msgList.add("âš ï¸ I could not verify this Payment ID with Razorpay.");
			if(errorReason != "")
			{
				msgList.add(errorReason);
			}
			msgList.add("Please double-check the Payment ID from your Razorpay success screen.");
			msgList.add("If you have not paid yet, first buy the product using *Pay with Razorpay*, then click *Payment Done âœ…* again.");
			q = Map();
			q.put("name","procurex");
			q.put("replies",msgList);
			q.put("suggestions",{"Show Products","Payment Done âœ…","Main Menu"});
			response.put("questions",{q});
			return response;
		}
		newUsed = Map();
		newUsed.put("id",apiPaymentId);
		newUsed.put("product",prodName);
		newUsed.put("amount",prodPrice);
		usedPayments.add(newUsed);
		saveUsed = Map();
		saveUsed.put("nf_used_payments",usedPayments);
		zoho.salesiq.visitorsession.set(portalId,saveUsed);
		if(uemail != "" && paymentId != "")
		{
			sendmail
			[
				from :zoho.adminuserid
				to :uemail
				subject :"MedKit â€“ Order Confirmation for " + uname
				message :"<div style='background:#f4f7fb;padding:24px 0;font-family:Arial,sans-serif;'><div style='max-width:600px;margin:0 auto;background:#ffffff;border-radius:12px;overflow:hidden;border:1px solid #e2e8f0;'><div style='background:#0f766e;color:#ffffff;padding:20px 24px;text-align:center;'><div style='font-size:22px;font-weight:700;'>MedKit Nutrition</div><div style='font-size:14px;margin-top:4px;'>We are fetching your order ğŸ©º</div></div><div style='padding:20px 24px;font-size:14px;color:#111827;'>Hi " + uname + ",<br><br>Thank you for shopping with <b>MedKit Nutrition</b>! Your payment has been <b>successfully verified</b> and your order is now being processed.</div><div style='padding:0 24px 20px 24px;'><div style='margin:0 auto 16px auto;padding:16px;border-radius:12px;background:#ecfdf5;border:1px solid #bbf7d0;'><div style='font-size:13px;font-weight:600;color:#16a34a;margin-bottom:8px;'>Order Summary</div><div style='font-size:14px;color:#111827;'><b>Product:</b> " + prodName + "<br><b>Amount Paid:</b> â‚¹" + prodPrice + "<br><b>Payment Reference:</b> " + paymentId + "</div></div><div style='font-size:12px;color:#4b5563;margin-bottom:16px;'>Your MedKit order is being prepared. You will receive another email once it is shipped. ğŸšš</div></div><div style='background:#0f172a;color:#e5e7eb;text-align:center;padding:14px 16px;font-size:11px;'>Thank you for choosing <b>MedKit</b> for your daily nutrition ğŸ©ºğŸŒ±</div></div></div>"
			]
		}
		emailMsg = "";
		if(uemail != "")
		{
			emailMsg = "A confirmation email has been sent to " + uemail + ".";
		}
		else
		{
			emailMsg = "Email not available, so confirmation mail was not sent.";
		}
		try 
		{
			invNo = "INV" + randomNumber(100000,999999).toString();
			customerDisplay = uname;
			if(uemail != null && uemail.trim() != "")
			{
				customerDisplay = uname + " (" + uemail + ")";
			}
			invoiceText = "";
			invoiceText = invoiceText + "-------------------------------------\n";
			invoiceText = invoiceText + "  ğŸ§¾ **MEDKIT PRODUCT INVOICE**\n";
			invoiceText = invoiceText + "-------------------------------------\n";
			invoiceText = invoiceText + "**Invoice No** : " + invNo + "\n";
			invoiceText = invoiceText + "**Customer**   : " + customerDisplay + "\n";
			invoiceText = invoiceText + "**Product**    : " + prodName + "\n";
			invoiceText = invoiceText + "**Amount**     : **â‚¹" + prodPrice + "**\n";
			invoiceText = invoiceText + "**Payment ID** : " + paymentId + "\n";
			invoiceText = invoiceText + "**Status**     : Verified (Captured)\n";
			invoiceText = invoiceText + "-------------------------------------\n";
			invoiceText = invoiceText + "**Thank You For Shopping With MedKit! ğŸ™Œ**\n";
			invoiceText = invoiceText + "ğŸ“¦ Our MedKit Delivery Team Will Contact You Soon.\n";
			card = Map();
			card.put("type","links");
			card.put("text",invoiceText);
			if(prodImg != null && prodImg.trim() != "")
			{
				card.put("image",prodImg);
				card.put("image_position","fit");
			}
			links = List();
			supportBtn = Map();
			supportBtn.put("text","Visit MedKit Store");
			supportBtn.put("url","https://medkit-mart.netlify.app/");
			links.add(supportBtn);
			card.put("links",links);
			q = Map();
			q.put("name","procurex");
			q.put("replies",{"âœ… Payment verified successfully with Razorpay! ğŸ‰","Here is your invoice:",card});
			q.put("suggestions",{"More Products","Main Menu","Back"});
			response.put("action","context");
			response.put("context_id","procurex");
			response.put("questions",{q});
			return response;
		}
		catch (e)
		{
			response.put("action","context");
			response.put("context_id","procurex");
			q = Map();
			q.put("name","procurex");
			q.put("replies",{"âœ… Payment Verified!","Invoice created, but a minor error occurred while rendering the card."});
			q.put("suggestions",{"More Products","Main Menu","Back"});
			response.put("questions",{q});
			return response;
		}
	}
	if(trigLower.contains("about purchasing"))
	{
		response.put("action","context");
		response.put("context_id","procurex");
		q = Map();
		q.put("name","procurex");
		q.put("replies",{"Here is how ProcureX â€“ MedKit purchasing works ğŸ›’:","1ï¸âƒ£ Click *MedKit Products ğŸ›’* to start.","2ï¸âƒ£ Enter your *name* and *email address*.","3ï¸âƒ£ We send a 6-digit *OTP* to your email for verification.","4ï¸âƒ£ After OTP is verified, we show product cards with a *Pay with Razorpay* button.","5ï¸âƒ£ Complete the payment using Razorpay.","6ï¸âƒ£ Click *Payment Done âœ…* and paste your *Razorpay Payment ID*.","7ï¸âƒ£ You will receive a MedKit *order confirmation email* with your product and payment details. ğŸ‰"});
		q.put("suggestions",{"ğŸ›ï¸ MedKit Products","Main Menu","Back"});
		response.put("questions",{q});
		return response;
	}
	if(trigLower.contains("payment done"))
	{
		sessSet = Map();
		sessSet.put("nf_need_payment_id",true);
		zoho.salesiq.visitorsession.set(portalId,sessSet);
		response.put("action","context");
		response.put("context_id","procurex");
		q = Map();
		q.put("name","nf_payment_id");
		q.put("replies",{"Awesome! ğŸ‰","Please enter your Razorpay Payment ID (example: Rjbv2T2***** or pay_29QQoU*****f)."});
		inputMap = Map();
		inputMap.put("type","name");
		inputMap.put("placeholder","Eg. Rjbv2T2******L");
		q.put("input",inputMap);
		response.put("questions",{q});
		return response;
	}
	if(trigLower.contains("more products") || trigLower.contains("more product") || trigLower.contains("show products") || trigLower.contains("show product"))
	{
		currIndex = 0;
		try 
		{
			pResp = zoho.salesiq.visitorsession.get(portalId,"nf_product_index");
			if(pResp.containsKey("data"))
			{
				currIndex = ifnull(pResp.get("data").get("nf_product_index"),0).toNumber();
			}
		}
		catch (e)
		{
			currIndex = 0;
		}
		nextIndex = (currIndex + 1) % prodCount;
		idxMap = Map();
		idxMap.put("nf_product_index",nextIndex);
		zoho.salesiq.visitorsession.set(portalId,idxMap);
		prod = products.get(nextIndex);
		prodName = prod.get("name");
		prodPrice = prod.get("price");
		prodDesc = prod.get("desc");
		prodImg = prod.get("img");
		uname = ifnull(answers.get("nf_name").get("text"),"Customer");
		uemail = ifnull(answers.get("nf_email").get("text"),"");
		payUrl = "https://razorpay.com/";
		try 
		{
			amountPaise = (prodPrice.toNumber() * 100).toLong();
			payPayload = Map();
			payPayload.put("amount",amountPaise);
			payPayload.put("currency","INR");
			payPayload.put("description",prodName + " - MedKit Nutrition");
			customer = Map();
			customer.put("name",uname);
			customer.put("email",uemail);
			payPayload.put("customer",customer);
			headerMap = Map();
			headerMap.put("Content-Type","application/json");
			payResp = invokeurl
			[
				url :"https://api.razorpay.com/v1/payment_links"
				type :POST
				parameters:payPayload.toString()
				headers:headerMap
				connection:"razorpay_test"
			];
			if(payResp.containsKey("short_url"))
			{
				payUrl = payResp.get("short_url");
			}
		}
		catch (e)
		{
			payUrl = "https://razorpay.com/";
		}
		infoUrl = "https://medkit-mart.netlify.app/";
		linksList = List();
		payMap = Map();
		payMap.put("url",payUrl);
		payMap.put("text","Pay with Razorpay");
		payMap.put("icon","https://cdn-icons-png.flaticon.com/512/1170/1170678.png");
		linksList.add(payMap);
		infoMap = Map();
		infoMap.put("url",infoUrl);
		infoMap.put("text","Know about this product");
		linksList.add(infoMap);
		card = Map();
		card.put("type","links");
		card.put("text",prodName + " â€” â‚¹" + prodPrice + "\n" + prodDesc);
		card.put("image",prodImg);
		card.put("image_position","fit");
		card.put("links",linksList);
		response.put("action","context");
		response.put("context_id","procurex");
		q = Map();
		q.put("name","procurex");
		q.put("replies",{"ğŸ›ï¸ Welcome to MedKit Premium Checkout â€” pay securely with Razorpay ğŸ’³:",card});
		q.put("suggestions",{"More Products","Payment Done âœ…","Main Menu"});
		response.put("questions",{q});
		return response;
	}
	if(answers.containsKey("nf_otp"))
	{
		enteredOtp = answers.get("nf_otp").get("text");
		realOtp = "";
		try 
		{
			vsResp = zoho.salesiq.visitorsession.get(portalId,"nf_otp_value");
			if(vsResp.containsKey("data"))
			{
				realOtp = ifnull(vsResp.get("data").get("nf_otp_value"),"");
			}
		}
		catch (e)
		{
			realOtp = "";
		}
		if(enteredOtp != realOtp)
		{
			response.put("action","context");
			response.put("context_id","procurex");
			q = Map();
			q.put("name","nf_otp");
			q.put("replies",{"âŒ That OTP is incorrect. Please enter the correct 6-digit OTP sent to your email."});
			inputMap = Map();
			inputMap.put("type","name");
			inputMap.put("placeholder","Enter OTP again");
			q.put("input",inputMap);
			response.put("questions",{q});
			return response;
		}
		idxMap = Map();
		idxMap.put("nf_product_index",0);
		zoho.salesiq.visitorsession.set(portalId,idxMap);
		prod = products.get(0);
		prodName = prod.get("name");
		prodPrice = prod.get("price");
		prodDesc = prod.get("desc");
		prodImg = prod.get("img");
		uname = ifnull(answers.get("nf_name").get("text"),"Customer");
		uemail = ifnull(answers.get("nf_email").get("text"),"");
		payUrl = "https://razorpay.com/";
		try 
		{
			amountPaise = (prodPrice.toNumber() * 100).toLong();
			payPayload = Map();
			payPayload.put("amount",amountPaise);
			payPayload.put("currency","INR");
			payPayload.put("description",prodName + " - MedKit Nutrition");
			customer = Map();
			customer.put("name",uname);
			customer.put("email",uemail);
			payPayload.put("customer",customer);
			headerMap = Map();
			headerMap.put("Content-Type","application/json");
			payResp = invokeurl
			[
				url :"https://api.razorpay.com/v1/payment_links"
				type :POST
				parameters:payPayload.toString()
				headers:headerMap
				connection:"razorpay_test"
			];
			if(payResp.containsKey("short_url"))
			{
				payUrl = payResp.get("short_url");
			}
		}
		catch (e)
		{
			payUrl = "https://razorpay.com/";
		}
		infoUrl = "https://medkit-mart.netlify.app/";
		linksList = List();
		payMap = Map();
		payMap.put("url",payUrl);
		payMap.put("text","Pay with Razorpay");
		payMap.put("icon","https://cdn-icons-png.flaticon.com/512/1170/1170678.png");
		linksList.add(payMap);
		infoMap = Map();
		infoMap.put("url",infoUrl);
		infoMap.put("text","Know about this product");
		linksList.add(infoMap);
		card = Map();
		card.put("type","links");
		card.put("text",prodName + " â€” â‚¹" + prodPrice + "\n" + prodDesc);
		card.put("image",prodImg);
		card.put("image_position","fit");
		card.put("links",linksList);
		response.put("action","context");
		response.put("context_id","procurex");
		q = Map();
		q.put("name","procurex");
		q.put("replies",{"âœ… OTP Verified Successfully! ğŸ‰","Your product is ready â€” Get Your MedKit Product ğŸ©º:",card});
		q.put("suggestions",{"More Products","Payment Done âœ…","Main Menu"});
		response.put("questions",{q});
		return response;
	}
	if(answers.containsKey("nf_email") && !answers.containsKey("nf_otp"))
	{
		uname = answers.get("nf_name").get("text");
		uemail = answers.get("nf_email").get("text");
		isValidEmail = true;
		if(uemail == null || uemail.trim() == "")
		{
			isValidEmail = false;
		}
		else if(uemail.indexOf("@") == -1 || uemail.indexOf(".") == -1)
		{
			isValidEmail = false;
		}
		if(!isValidEmail)
		{
			response.put("action","context");
			response.put("context_id","procurex");
			q = Map();
			q.put("name","nf_email");
			q.put("replies",{"âŒ That does not look like a valid email.","Hi " + uname + ", please enter a correct email address (example: user@gmail.com) so I can send your OTP ğŸ”."});
			inputMap = Map();
			inputMap.put("type","email");
			inputMap.put("placeholder","example@gmail.com");
			inputMap.put("error",{"Enter a valid email"});
			q.put("input",inputMap);
			response.put("questions",{q});
			return response;
		}
		otpNum = randomNumber(100000,999999);
		otpStr = otpNum.toString();
		sessMap = Map();
		sessMap.put("nf_otp_value",otpStr);
		sessMap.put("nf_name",uname);
		sessMap.put("nf_email",uemail);
		zoho.salesiq.visitorsession.set(portalId,sessMap);
		sendmail
		[
			from :zoho.adminuserid
			to :uemail
			subject :"MedKit - Here is your OTP"
			message :"<div style='background:#f7f7fb;padding:32px 0;font-family:Arial,Helvetica,sans-serif;'><div style='max-width:600px;margin:0 auto;background:#ffffff;border-radius:12px;padding:32px 28px;border:1px solid #e5e7eb;text-align:center;'><img src='https://strange-aqua-5yfklivwfj-muznn4xg3b.edgeone.dev/MEDOOO.jpg' alt='MedKit' style='width:60px;margin-bottom:12px;'><h2 style='color:#111827;margin:0 0 12px 0;font-weight:700;'>Verify your MedKit Account</h2><p style='color:#4b5563;font-size:14px;margin:0 0 22px 0;'>We received a verification request for your MedKit account. Enter the code below in the chatbot to continue.</p><div style='background:#f3f4f6;padding:18px 0;font-size:32px;font-weight:700;border-radius:10px;color:#111827;margin-bottom:22px;'>" + otpStr + "</div><p style='color:#6b7280;font-size:12px;margin-bottom:22px;'>If you did not request this code, please ignore this email. This OTP is valid for 10 minutes.</p><hr style='border:none;border-top:1px solid #e5e7eb;margin:24px 0;'><p style='font-size:12px;color:#9ca3af;'>MedKit â€“ Your trusted partner in daily nutrition ğŸ©ºğŸŒ±</p></div></div>"
		]
		response.put("action","context");
		response.put("context_id","procurex");
		q = Map();
		q.put("name","nf_otp");
		q.put("replies",{"We Have Sent a 6-Digit OTP to **" + uemail + "**. Please Enter It Below ğŸ”:"});
		inputMap = Map();
		inputMap.put("type","name");
		inputMap.put("placeholder","Enter OTP");
		q.put("input",inputMap);
		response.put("questions",{q});
		return response;
	}
	if(answers.containsKey("nf_name") && !answers.containsKey("nf_email"))
	{
		uname = answers.get("nf_name").get("text");
		response.put("action","context");
		response.put("context_id","procurex");
		q = Map();
		q.put("name","nf_email");
		q.put("replies",{"Hi **" + uname + "**, Please Enter Your **Email** So I Can Send Your OTP ğŸ”."});
		inputMap = Map();
		inputMap.put("type","email");
		inputMap.put("placeholder","medkit@gmail.com");
		inputMap.put("error",{"Enter a valid email"});
		q.put("input",inputMap);
		response.put("questions",{q});
		return response;
	}
	if(trigLower.contains("ğŸ›ï¸ MedKit Products") || trigLower.contains("medkit products") || trigLower.contains("nutrition food"))
	{
		response.put("action","context");
		response.put("context_id","procurex");
		q = Map();
		q.put("name","nf_name");
		q.put("replies",{"Great Choice! ğŸ›’ Please Share Your **Name** So I Can Show You Our MedKit Products ğŸ˜Š"});
		inputMap = Map();
		inputMap.put("type","name");
		inputMap.put("placeholder","Enter your name!");
		q.put("input",inputMap);
		response.put("questions",{q});
		return response;
	}
}
// End procurex Context Handler
// ----------------------------------------------------------------------------------------
if(context_id.equals("fitnessopt"))
{
	opt = answers.get("getFitnessOpt").get("text");
	if(opt.containsIgnoreCase("Pregnancy Zone"))
	{
		response.put("action","context");
		response.put("context_id","pregnancy_month");
		question = {"name":"preg_month","replies":{"Welcome to **Pregnancy Zone** ğŸ¤°Baby bump month? ğŸ˜Š (1â€“9))"},"input":{"type":"name","placeholder":"Enter your pregnancy month (1â€“9)","value":"","error":{"Please enter a valid month (1â€“9)"}},"suggestions":{"Main Menu"}};
		response.put("questions",{question});
		return response;
	}
	if(opt.containsIgnoreCase("Exercise ğŸ‹ï¸"))
	{
		response.put("action","context");
		response.put("context_id","exercisegenerator");
		question = {"name":"exerciseselect","replies":{"Here's a Short **Exercise** to boost your mood ğŸ¤—"},"suggestions":{"Go Ahead","Back","Main Menu"}};
		response.put("questions",{question});
		return response;
	}
	if(opt.containsIgnoreCase("Dietrix ğŸ¥—"))
	{
		response.put("action","context");
		response.put("context_id","dietaryopt");
		question = {"name":"customizeOrNot","replies":{"When **Diet Is Wrong**, Medicine is of no use.","When **Diet Is Correct**, Medicine is of no need !!âœ¨"},"suggestions":{"Lets Proceed","Meal Plan","Back","Main menu"}};
		response.put("questions",{question});
		return response;
	}
	if(opt.containsIgnoreCase("Yoga ğŸ§˜"))
	{
		response.put("action","context");
		response.put("context_id","yogagenerator");
		question = {"name":"yogaselect","replies":{"ğŸ§˜ Yoga helps **Calm Your Mind** and improve flexibility!"},"suggestions":{"Go","Back","Main Menu"}};
		response.put("questions",{question});
		return response;
	}
	if(opt.containsIgnoreCase("Wellness Meetup ğŸŒ¿"))
	{
		response.put("action","context");
		response.put("context_id","community_meetup");
		question = {"name":"community_meetup","replies":{"ğŸŒ¿ Welcome to the **Community Wellness Meetup!**"},"suggestions":{"Join Now","Back"}};
		response.put("questions",{question});
		return response;
	}
}
if(context_id != null && context_id.equals("community_meetup"))
{
	response = Map();
	if(answers != null && answers.containsKey("community_meetup"))
	{
		backTxt = ifnull(answers.get("community_meetup").get("text"),"");
		backTxt = backTxt.toLowerCase();
		backTxt = backTxt.trim();
		if(backTxt.contains("back"))
		{
			response = Map();
			response.put("action","context");
			response.put("context_id","fitnessopt");
			q = {"name":"getFitnessOpt","replies":{"Welcome to **FitZone!** Being healthy and fit isn't a fad or a trendâ€”it's a lifestyle ğŸ’ªğŸ»"},"suggestions":{"Pregnancy ZoneğŸ¤°","Dietrix ğŸ¥—","Yoga ğŸ§˜","Exercise ğŸ‹ï¸","Wellness Meetup ğŸŒ¿","Main Menu"}};
			response.put("questions",{q});
			return response;
		}
	}
	userChoice = "";
	if(answers.containsKey("community_meetup"))
	{
		userChoice = ifnull(answers.get("community_meetup").get("text"),"");
	}
	if(userChoice.equalsIgnoreCase("Join Now"))
	{
		meetupLink = "https://calendly.com/mohamedsilar26/30min";
		try 
		{
			meResp = invokeurl
			[
				url :"https://api.calendly.com/users/me"
				type :GET
				connection:"calendly_connectionn"
			];
			info "Calendly /users/me: " + meResp;
			if(meResp != null && meResp.containsKey("resource"))
			{
				res = meResp.get("resource");
				if(res.containsKey("scheduling_url"))
				{
					baseUrl = "" + res.get("scheduling_url");
					if(baseUrl.endsWith("/"))
					{
						meetupLink = baseUrl + "medkit";
					}
					else
					{
						meetupLink = baseUrl + "/medkit";
					}
				}
			}
		}
		catch (e)
		{
			info "âŒ Calendly simple link error (using fallback): " + e.toString();
		}
		card = Map();
		card.put("type","links");
		card.put("text","ğŸŒ¿ *Community Wellness Meetup*\nJoin our weekly space for mindfulness, healthy habits, and guided relaxation.\n\nInvite your friends â€” itâ€™s a calm, supportive group session. ğŸŒ¼");
		card.put("image","https://special-fuchsia-b7zwstvgh2-v684515qa9.edgeone.dev/MEETUP.jpg");
		links = List();
		btn = Map();
		btn.put("text","ğŸ“… Reserve Your Spot");
		btn.put("url","https://calendly.com/mohamedsilar26/30min");
		links.add(btn);
		card.put("links",links);
		response.put("action","context");
		response.put("context_id","community_meetup");
		// keep context on the meetup card
		question = {"name":"community_meetup","replies":{card},"suggestions":{"Back"}};
		response.put("questions",{question});
		return response;
	}
	response.put("action","context");
	response.put("context_id","community_meetup");
	question = {"name":"community_meetup","replies":{"ğŸ¤ Youâ€™re always welcome! Thanks for being part of our community âœ¨"},"suggestions":{"Thank You","Back"}};
	response.put("questions",{question});
	return response;
}
if(context_id != null && context_id.equals("pregnancy_month"))
{
	// ---------- BACK handler: if user pressed Back from the preg_month card ----------
	if(answers.containsKey("preg_month"))
	{
		backTxt = ifnull(answers.get("preg_month").get("text"),"");
		backTxt = backTxt.toLowerCase();
		backTxt = backTxt.trim();
		if(backTxt.contains("back"))
		{
			response = Map();
			response.put("action","context");
			response.put("context_id","fitnessopt");
			question = {"name":"getFitnessOpt","replies":{"Welcome to **FitZone!** Being healthy and fit isn't a fad or a trendâ€”it's a lifestyle ğŸ’ªğŸ»"},"suggestions":{"Pregnancy ZoneğŸ¤°","Dietrix ğŸ¥—","Yoga ğŸ§˜","Exercise ğŸ‹ï¸","Wellness Meetup ğŸŒ¿","Main Menu"}};
			response.put("questions",{question});
			return response;
		}
	}
	// ---------- Normal pregnancy-month processing ----------
	userInput = ifnull(answers.get("preg_month").get("text"),"").trim();
	reply = "";
	month = 0;
	isValidNumber = true;
	try 
	{
		month = userInput.toLong();
	}
	catch (e)
	{
		isValidNumber = false;
	}
	// Invalid input handling: return as question card with input (so user can re-enter)
	if(!isValidNumber || month < 1 || month > 9)
	{
		errMsg = "";
		if(!isValidNumber)
		{
			errMsg = "ğŸ˜… Oops! Please enter a **number** between **1 and 9** (like 3 or 7).";
		}
		else if(month < 1)
		{
			errMsg = "ğŸ˜… Pregnancy canâ€™t be **" + month + " month(s)** yet! Please enter between **1 and 9**.";
		}
		else if(month > 9)
		{
			errMsg = "ğŸ¥° No pregnancy lasts **" + month + " months**! Baby usually comes by **9 months** ğŸ‘¶ğŸ’–\n\nPlease enter a month between **1 and 9**.";
		}
		response = Map();
		response.put("action","context");
		response.put("context_id","pregnancy_month");
		q = {"name":"preg_month","replies":{errMsg},"input":{"type":"name","placeholder":"Enter your pregnancy month (1â€“9)","value":"","error":{"Please enter a valid month between 1 and 9 ğŸ˜‡"}},"suggestions":{"Back"}};
		response.put("questions",{q});
		return response;
	}
	// ---------- Build trimester-specific reply ----------
	if(month == 1 || month == 2 || month == 3)
	{
		reply = "ğŸ¤°âœ¨ **First Trimester (Month " + month + ")** âœ¨\n\n";
		reply = reply + "Here are your safe fitness tips, mama ğŸ’–ğŸ¼\n\n";
		reply = reply + "ğŸ‘£ âœ” Light walking (15â€“20 minutes)\n";
		reply = reply + "ğŸ’— âœ” Pelvic floor exercises (Kegels)\n";
		reply = reply + "ğŸŒ¸ âœ” Light stretching & gentle movements\n";
		reply = reply + "âš ï¸ âœ” Avoid heavy lifting\n\n";
	}
	else if(month == 4 || month == 5 || month == 6)
	{
		reply = "ğŸ¤°ğŸŒ¼ **Second Trimester (Month " + month + ")** ğŸŒ¼\n\n";
		reply = reply + "Your energy improvesâ€”great time for safe workouts ğŸ‘¶ğŸ’ª\n\n";
		reply = reply + "ğŸš¶â€â™€ï¸ âœ” Walking or swimming\n";
		reply = reply + "ğŸ‹ï¸â€â™€ï¸ âœ” Light strength training\n";
		reply = reply + "ğŸ§˜ âœ” Gentle pregnancy yoga\n\n";
	}
	else if(month >= 7 && month <= 9)
	{
		reply = "ğŸ¤°ğŸŒŸ **Third Trimester (Month " + month + ")** ğŸŒŸ\n\n";
		reply = reply + "You're almost there, mama! Stay active but gentle ğŸ’•ğŸ¼\n\n";
		reply = reply + "ğŸ‘£ âœ” Short gentle walks\n";
		reply = reply + "ğŸŒ¬ï¸ âœ” Breathing & relaxation exercises\n";
		reply = reply + "ğŸ¤ âœ” Gentle stretching & mobility\n\n";
	}
	reply = reply + "ğŸ“– **You can read more here:**\n\n";
	reply = reply + "ğŸ”— NHS Pregnancy Exercise: https://www.nhs.uk/pregnancy/keeping-well/exercise/ \n\n";
	reply = reply + "ğŸ“„ Pregnancy Care Guidelines (PDF): https://nhm.gov.in/images/pdf/guidelines/nrhm-guidelines/stg/pregnancy-care.pdf \n";
	reply = reply + "\n\nğŸ’– **Stay healthy, stay strong â€” you're growing a little miracle!** ğŸ‘¶";
	response = Map();
	response.put("action","context");
	response.put("context_id","pregnancy_month");
	question = {"name":"preg_month","replies":{reply},"suggestions":{"Back"}};
	response.put("questions",{question});
	return response;
}
if(context_id.equals("exercisegenerator"))
{
	// ---------- BACK handler: if user pressed Back from the exerciseselect card ----------
	if(answers.containsKey("exerciseselect"))
	{
		backTxt = ifnull(answers.get("exerciseselect").get("text"),"");
		backTxt = backTxt.toLowerCase();
		backTxt = backTxt.trim();
		if(backTxt.contains("back"))
		{
			response = Map();
			response.put("action","context");
			response.put("context_id","fitnessopt");
			question = {"name":"getFitnessOpt","replies":{"Welcome to **FitZone!** Being healthy and fit isn't a fad or a trendâ€”it's a lifestyle ğŸ’ªğŸ»"},"suggestions":{"Pregnancy ZoneğŸ¤°","Dietrix ğŸ¥—","Yoga ğŸ§˜","Exercise ğŸ‹ï¸","Wellness Meetup ğŸŒ¿","Main Menu"}};
			response.put("questions",{question});
			return response;
		}
	}
	// ---------- Normal exercise generation flow ----------
	trigger = "";
	if(answers.containsKey("exerciseselect"))
	{
		raw = answers.get("exerciseselect").get("text");
		if(raw != null)
		{
			trigger = raw.toLowerCase();
		}
	}
	if(trigger.contains("go") || trigger.contains("go ahead") || trigger.contains("one more") || trigger.contains("another"))
	{
		exercises = List();
		e1 = {"name":"10 Gentle Squats","bodyPart":"Legs","target":"Quads & Glutes","gif":"https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExNTk1Ym41aTlycnE0dWt6b2szaG4wc2Q1a3NqNW8zdzd6dXhoN2J0biZlcD12MV9naWZzX3NlYXJjaCZjdD1n/BIQjXVXfZHoOWdiTkW/giphy.gif"};
		exercises.add(e1);
		e2 = {"name":"12 Knee Push-ups","bodyPart":"Chest","target":"Pectorals & Triceps","gif":"https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExbW4wcHdnZmFjanE4dTNhZmRzaGQ5eXl1OWU5NW5weGh4NHZsZjNvMSZlcD12MV9naWZzX3NlYXJjaCZjdD1n/wOaG2yUiBLar5YFvrr/giphy.gif"};
		exercises.add(e2);
		e3 = {"name":"15 Standing Calf Raises","bodyPart":"Calves","target":"Gastrocnemius","gif":"https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExaWcxc2JwZW1pMHl1bTlubmo1OGpmZjBiaTQzbXMwOWxmeHdyaGR4OSZlcD12MV9naWZzX3NlYXJjaCZjdD1n/XEDNpGzZ8IXhBRqfwS/giphy.gif"};
		exercises.add(e3);
		e4 = {"name":"20-Second Plank","bodyPart":"Core","target":"Abs & Back","gif":"https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExZXQ0MHVidG1ldDFscTRpMW9nNTRlZnZuZDM1MHc3ZzY0MnhyNTN1MCZlcD12MV9naWZzX3NlYXJjaCZjdD1n/3o6ZtjwGA5CKEt4Wc0/giphy.gif"};
		exercises.add(e4);
		e5 = {"name":"10 Jumping Jacks","bodyPart":"Full Body","target":"Cardio & Shoulders","gif":"https://media3.giphy.com/media/v1.Y2lkPTc5MGI3NjExeGt6aHNnN3l2azNuaTNnazNmeWk3ZmM1YzB3MnJsZ3prMXJ3ZXRuciZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/ckMk3RKUK29lziaspI/giphy.gif"};
		exercises.add(e5);
		sizeInt = exercises.size();
		idx = 0;
		if(trigger.contains("go") || trigger.contains("go ahead"))
		{
			idx = 0;
		}
		else
		{
			secs = (zoho.currenttime.toLong() / 1000).toNumber();
			idx = (secs % sizeInt).toNumber();
		}
		if(idx < 0 || idx >= sizeInt)
		{
			idx = 0;
		}
		item = exercises.get(idx);
		exName = ifnull(item.get("name"),"Exercise");
		exBody = ifnull(item.get("bodyPart"),"General");
		exTarget = ifnull(item.get("target"),"General");
		gifUrl = ifnull(item.get("gif"),"");
		if(gifUrl == null || gifUrl == "")
		{
			gifUrl = "https://media.giphy.com/media/3o7aD2saalBwwftBIY/giphy.gif";
		}
		linksList = List();
		demoMap = Map();
		demoMap.put("url",gifUrl);
		demoMap.put("text","View Demo");
		demoMap.put("icon","https://cdn-icons-png.flaticon.com/512/709/709496.png");
		linksList.add(demoMap);
		howMap = Map();
		howMap.put("url","https://www.google.com/search?q=how+to+" + replaceAll(exName," ","+"));
		howMap.put("text","How To");
		howMap.put("icon","https://cdn-icons-png.flaticon.com/512/1250/1250680.png");
		linksList.add(howMap);
		card = Map();
		card.put("type","links");
		card.put("text",exName + " â€” " + exTarget + " (" + exBody + ")");
		card.put("image",gifUrl);
		card.put("image_position","fit");
		card.put("links",linksList);
		response.put("action","context");
		response.put("context_id","exercisegenerator");
		q = Map();
		q.put("name","exerciseselect");
		q.put("replies",{card});
		// include Back suggestion so user can return to FitZone
		q.put("suggestions",{"One more","Back","Main Menu"});
		response.put("questions",{q});
		return response;
	}
}
if(context_id.equals("yogagenerator"))
{
	if(answers != null && answers.containsKey("yogaselect"))
	{
		bs = ifnull(answers.get("yogaselect").get("text"),"");
		bs = bs.toLowerCase();
		bs = bs.trim();
		if(bs.contains("back"))
		{
			response = Map();
			response.put("action","context");
			response.put("context_id","fitnessopt");
			question = {"name":"getFitnessOpt","replies":{"Welcome to **FitZone!** Being healthy and fit isn't a fad or a trendâ€”it's a lifestyle ğŸ’ªğŸ»"},"suggestions":{"Pregnancy ZoneğŸ¤°","Dietrix ğŸ¥—","Yoga ğŸ§˜","Exercise ğŸ‹ï¸","Wellness Meetup ğŸŒ¿","Main Menu"}};
			response.put("questions",{question});
			return response;
		}
	}
	trigger = "";
	if(answers != null && answers.containsKey("yogaselect"))
	{
		qs = answers.get("yogaselect");
		if(qs != null && qs.get("text") != null)
		{
			trigger = "" + qs.get("text");
			trigger = trigger.toLowerCase();
			trigger = trigger.trim();
		}
	}
	if(trigger.contains("go") || trigger.contains("more") || trigger.contains("another"))
	{
		cards = List();
		url = "https://api.pexels.com/videos/search?query=yoga&per_page=3";
		pexelsResp = null;
		try 
		{
			pexelsResp = invokeurl
			[
				url :url
				type :GET
				connection:"pexels_video"
			];
		}
		catch (apiErr)
		{
			pexelsResp = null;
		}
		videos = List();
		try 
		{
			if(pexelsResp != null && pexelsResp.get("videos") != null)
			{
				videos = pexelsResp.get("videos");
			}
		}
		catch (e)
		{
			videos = List();
		}
		index = 0;
		for each  v in videos
		{
			if(index < 3)
			{
				title = "Yoga Pose";
				thumb = "";
				demoUrl = "";
				try 
				{
					if(v.get("image") != null)
					{
						thumb = "" + v.get("image");
					}
				}
				catch (e1)
				{
					thumb = "";
				}
				try 
				{
					vf = v.get("video_files");
					if(vf != null && vf.size() > 0)
					{
						found = false;
						for each  f in vf
						{
							try 
							{
								if(!found && f.get("link") != null)
								{
									demoUrl = "" + f.get("link");
									found = true;
								}
							}
							catch (ff)
							{
							}
						}
					}
				}
				catch (e2)
				{
					demoUrl = "";
				}
				try 
				{
					if(v.get("user") != null && v.get("user").get("name") != null)
					{
						title = "Yoga video by " + v.get("user").get("name");
					}
				}
				catch (e3)
				{
					title = "Yoga Pose";
				}
				try 
				{
					if(v.get("id") != null)
					{
						idd = "" + v.get("id");
						title = title + " (" + idd + ")";
					}
				}
				catch (ignore)
				{
				}
				if(thumb == "")
				{
					thumb = "https://images.pexels.com/photos/3823039/pexels-photo-3823039.jpeg";
				}
				if(demoUrl == "")
				{
					demoUrl = "https://videos.pexels.com/video-files/2908179/2908179-uhd_2560_1440_24fps.mp4";
				}
				linksList = List();
				demoMap = Map();
				demoMap.put("url",demoUrl);
				demoMap.put("text","Download");
				demoMap.put("icon","https://cdn-icons-png.flaticon.com/512/709/709496.png");
				linksList.add(demoMap);
				howMap = Map();
				howMap.put("url","https://www.google.com/search?q=" + replaceAll(title," ","+") + "+yoga+how+to");
				howMap.put("text","How To");
				howMap.put("icon","https://cdn-icons-png.flaticon.com/512/1250/1250680.png");
				linksList.add(howMap);
				card = Map();
				card.put("type","links");
				card.put("text",title);
				card.put("image",thumb);
				card.put("image_position","fit");
				card.put("links",linksList);
				cards.add(card);
			}
			index = index + 1;
		}
		if(cards.size() == 0)
		{
			response.put("action","context");
			response.put("context_id","yogagenerator");
			q = Map();
			q.put("name","yogaselect");
			q.put("replies",{"No yoga videos found right now. Try again later."});
			q.put("suggestions",{"Retry","Back","Main Menu"});
			response.put("questions",{q});
			return response;
		}
		response.put("action","context");
		response.put("context_id","yogagenerator");
		q = Map();
		q.put("name","yogaselect");
		q.put("replies",cards);
		q.put("suggestions",{"One more","Back","Main Menu"});
		response.put("questions",{q});
		return response;
	}
}
//---------------------------------------------------------------------------------------
if(context_id.equals("dietaryopt"))
{
	ans = answers.get("customizeOrNot").get("text");
	if(ans.containsIgnoreCase("lets proceed"))
	{
		response.put("action","context");
		response.put("context_id","pickage");
		question = {"name":"disorder","replies":{"Let me know what bothers you ?"},"input":{"type":"multiple-select","options":{"Diabetes","Obesity","Heart Problems","Back"},"max_selection":"1"}};
		response.put("questions",{question});
		return response;
	}
	else if(ans.containsIgnoreCase("Main Menu"))
	{
		response.put("action","context");
		response.put("context_id","mainmenu");
		question = {"name":"select","replies":{"Hey buddy ğŸ™‹â€â™‚ï¸ Welcome to **MedKit** ğŸ©º! I'm here to guide you. Tell me what you'd like to do!"},"suggestions":{"MedKit Wellness Hub ğŸŒ¿","ğŸ‹ï¸ FitZone","ProcureX ğŸ›’","ğŸ’¬ Motivational Boost","ğŸ¤ Consult an Expert","ğŸ“ Help Desk"}};
		response.put("questions",{question});
		return response;
	}
	else if(ans.containsIgnoreCase("Meal Plan"))
	{
		response.put("action","context");
		response.put("context_id","mealplan_calories");
		question = {"name":"calories","replies":{"ğŸ”¥ Great! **How many Calories** should the Meal Plan Be? (Eg: 1800)"},"input":{"type":"name","placeholder":"Eg. 1800","value":"","error":{"âš ï¸ Enter a valid calorie value"}}};
		response.put("questions",{question});
		return response;
	}
	else if(ans.containsIgnoreCase("Back"))
	{
		response.put("action","context");
		response.put("context_id","fitnessopt");
		question = {"name":"getFitnessOpt","replies":{"Welcome to **FitZone!** Being healthy and fit isn't a fad or a trendâ€”it's a lifestyle ğŸ’ªğŸ»"},"suggestions":{"Pregnancy ZoneğŸ¤°","Dietrix ğŸ¥—","Yoga ğŸ§˜","Exercise ğŸ‹ï¸","Wellness Meetup ğŸŒ¿","Main Menu"}};
		response.put("questions",{question});
		return response;
	}
	else
	{
		response.put("action","context");
		response.put("context_id","main menu");
		question = {"name":"done","replies":{"It was nice chatting with you ğŸ˜Š Have a wonderful day! ğŸ‘‹"},"suggestions":{"Main Menu"}};
		response.put("questions",{question});
		return response;
	}
}
if(context_id.equals("pickage"))
{
	ans = answers.get("disorder").get("text");
	if(ans.containsIgnoreCase("Diabetes"))
	{
		response.put("action","context");
		response.put("context_id","diabetesopt");
		question = {"name":"select1","replies":{{"text":"I'm Here To **Support You With Care ğŸ’–** How Would You Like To Continue?"}},"suggestions":{"Suggest Me Some Remedies"}};
		response.put("questions",{question});
		return response;
	}
	else if(ans.containsIgnoreCase("Obesity"))
	{
		response.put("action","context");
		response.put("context_id","obesityopt");
		question = {"name":"select2","replies":{{"text":"I'm Here To **Support You With Care ğŸ’–** How Would You Like To Continue?"}},"suggestions":{"Suggest Me Some Remedies"}};
		response.put("questions",{question});
		return response;
	}
	else if(ans.containsIgnoreCase("Heart Problems"))
	{
		response.put("action","context");
		response.put("context_id","heartproblemopt");
		question = {"name":"select3","replies":{{"text":"I'm Here To **Support You With Care ğŸ’–** How Would You Like To Continue?"}},"suggestions":{"Suggest Me Some Remedies"}};
		response.put("questions",{question});
		return response;
	}
	else if(ans.containsIgnoreCase("Back"))
	{
		response.put("action","context");
		response.put("context_id","dietaryopt");
		question = {"name":"customizeOrNot","replies":{"When **Diet Is Wrong**, Medicine is of no use.","When **Diet Is Correct**, Medicine is of no need !!âœ¨"},"suggestions":{"Lets Proceed","Meal Plan","Back","Main menu"}};
		response.put("questions",{question});
		return response;
	}
	else
	{
		response.put("action","context");
		response.put("context_id","main menu");
		question = {"name":"done","replies":{"It was nice chatting with you ğŸ˜Š Have a wonderful day! ğŸ‘‹"},"suggestions":{"Thank You"}};
		response.put("questions",{question});
		return response;
	}
}
if(context_id.equals("diabetesopt"))
{
	txt = ifnull(answers.get("select1").get("text"),"");
	txtLower = txt.toLowerCase().trim();
	if(txtLower.contains("back"))
	{
		response = Map();
		response.put("action","context");
		response.put("context_id","dietaryopt");
		q = {"name":"customizeOrNot","replies":{"When **Diet Is Wrong**, Medicine is of no use.","When **Diet Is Correct**, Medicine is of no need !!âœ¨"},"suggestions":{"Lets Proceed","Meal Plan","Back","Main menu"}};
		response.put("questions",{q});
		return response;
	}
	if(txtLower.contains("suggest me some remedies"))
	{
		response = Map();
		response.put("action","context");
		response.put("context_id","diabetesopt");
		q = {"name":"select1","replies":{"**Here Are Some Diabetes Remedies:**","ğŸ¥— Eat More Fiber","ğŸš¶â€â™‚ï¸ Walk 30 Minutes Daily","ğŸ’§ Drink Enough Water","ğŸ§˜ Manage Stress Levels"},"suggestions":{"Back"}};
		response.put("questions",{q});
		return response;
	}
}
if(context_id.equals("obesityopt"))
{
	txt = ifnull(answers.get("select2").get("text"),"");
	txtLower = txt.toLowerCase().trim();
	if(txtLower.contains("back"))
	{
		response = Map();
		response.put("action","context");
		response.put("context_id","dietaryopt");
		q = {"name":"customizeOrNot","replies":{"When **Diet Is Wrong**, Medicine is of no use.","When **Diet Is Correct**, Medicine is of no need !!âœ¨"},"suggestions":{"Lets Proceed","Meal Plan","Back","Main menu"}};
		response.put("questions",{q});
		return response;
	}
	// ---------- Remedies ----------
	if(txtLower.contains("suggest me some remedies"))
	{
		response = Map();
		response.put("action","context");
		response.put("context_id","obesityopt");
		q = {"name":"select2","replies":{"**Here Are Some Obesity Remedies:**","ğŸ¥— Maintain a Calorie Deficit","ğŸš´ Exercise for 45 Minutes Daily","ğŸš° Drink Water Before Meals","ğŸŒ™ Sleep 7â€“8 Hours"},"suggestions":{"Back"}};
		response.put("questions",{q});
		return response;
	}
}
if(context_id.equals("heartproblemopt"))
{
	txt = ifnull(answers.get("select3").get("text"),"");
	txtLower = txt.toLowerCase().trim();
	// ---------- BACK ----------
	if(txtLower.contains("back"))
	{
		response = Map();
		response.put("action","context");
		response.put("context_id","dietaryopt");
		q = {"name":"customizeOrNot","replies":{"When **Diet Is Wrong**, Medicine is of no use.","When **Diet Is Correct**, Medicine is of no need !!âœ¨"},"suggestions":{"Lets Proceed","Meal Plan","Back","Main menu"}};
		response.put("questions",{q});
		return response;
	}
	// ---------- Remedies ----------
	if(txtLower.contains("suggest me some remedies"))
	{
		response = Map();
		response.put("action","context");
		response.put("context_id","heartproblemopt");
		q = {"name":"select3","replies":{"**Heart Care Remedies:**","â¤ï¸ Reduce Salt Intake","ğŸ«’ Use Healthy Fats","ğŸš¶ Walk Regularly","ğŸŒ¿ Include Omega-3-Rich Foods"},"suggestions":{"Back"}};
		response.put("questions",{q});
		return response;
	}
}
if(context_id.equals("mealplan_calories"))
{
	txt = ifnull(answers.get("calories").get("text"),"");
	txtLower = txt.toLowerCase().trim();
	if(txtLower.contains("back"))
	{
		response.put("action","context");
		response.put("context_id","dietaryopt");
		q = {"name":"customizeOrNot","replies":{"When **Diet Is Wrong**, Medicine is of no use.","When **Diet Is Correct**, Medicine is of no need !!âœ¨"},"suggestions":{"Lets Proceed","Meal Plan","Back","Main menu"}};
		response.put("questions",{q});
		return response;
	}
	if(txt == "")
	{
		response.put("action","context");
		response.put("context_id","mealplan_calories");
		q = {"name":"calories","replies":{"Please enter a valid calorie goal (e.g., 1500)."},"input":{"type":"number","placeholder":"Eg. 1500"},"suggestions":{"Back"}};
		response.put("questions",{q});
		return response;
	}
	url = "https://api.spoonacular.com/mealplanner/generate?timeFrame=day&targetCalories=" + txt;
	try 
	{
		data = invokeurl
		[
			url :url
			type :GET
			connection:"spoonacular_meal"
		];
		meals = data.get("meals");
		breakfast = meals.get(0).get("title");
		lunch = meals.get(1).get("title");
		dinner = meals.get(2).get("title");
		response.put("action","context");
		response.put("context_id","mealplan_calories");
		q = {"name":"calories","replies":{"âœ¨ Your personalised *" + txt + " Calorie* Meal Plan","ğŸ³ Breakfast: " + breakfast,"ğŸ¥— Lunch: " + lunch,"ğŸ½ï¸ Dinner: " + dinner},"suggestions":{"Back"}};
		response.put("questions",{q});
		return response;
	}
	catch (e)
	{
		response.put("action","reply");
		response.put("replies",{"âš ï¸ Failed to generate meal plan. Try again later."});
		response.put("suggestions",{"Back"});
		return response;
	}
}
// Motivational Boost Context Handler 
// ---------------------- DEPRESSED / MOTIVATE FLOW ----------------------
if(context_id != null && context_id.equals("depressedopt"))
{
	opt = answers.get("depressedOpt").get("text");
	if(opt.containsIgnoreCase("Back"))
	{
		response.put("action","context");
		response.put("context_id","depressedopt");
		question = {"name":"depressedOpt","replies":{"ğŸ˜Š Donâ€™t worry, your assistant is right here to lift you up ğŸ¤—"},"suggestions":{"Grab me some Books ğŸ“š","Spotify ğŸµ","Motivate me ğŸ’ª","Make me laugh ğŸ˜‚","MedTube ğŸ¥","Show me a meme ğŸ–¼ï¸","Tell me a story ğŸ“–","Play Games ğŸ®","Main Menu"}};
		response.put("questions",{question});
		return response;
	}
	else if(opt.containsIgnoreCase("Grab me some Books") || opt.containsIgnoreCase("Grab me some Books ğŸ“š") || opt.containsIgnoreCase("search more"))
	{
		response.put("action","context");
		response.put("context_id","gbooks");
		question = {"name":"gbook","replies":{"Will you tell me which genre should **I Suggest Books** for? (eg: romcom, novel, horror)"},"input":{"type":"name","placeholder":"Eg. romcom,novel,horror...","value":"","error":{"Enter a valid genre"}},"suggestions":{"Main Menu","Back"}};
		response.put("questions",{question});
		return response;
	}
	else if(opt != null && opt.containsIgnoreCase("MedTube ğŸ¥"))
	{
		// ---------- UNIVERSAL BACK HANDLER (DELUGE-SAFE) ----------
		if(answers != null)
		{
			keysList = answers.keys();
			// valid in Deluge
			for each  k in keysList
			{
				backTxt = ifnull(answers.get(k).get("text"),"");
				backTxt = backTxt.toLowerCase();
				backTxt = backTxt.trim();
				if(backTxt.contains("back"))
				{
					response = Map();
					response.put("action","context");
					response.put("context_id","depressedopt");
					q = {"name":"depressedOpt","replies":{"ğŸ˜Š Donâ€™t worry, your assistant is right here to lift you up ğŸ¤—"},"suggestions":{"Grab me some Books ğŸ“š","Spotify ğŸµ","Motivate me ğŸ’ª","Make me laugh ğŸ˜‚","MedTube ğŸ¥","Show me a meme ğŸ–¼ï¸","Tell me a story ğŸ“–","Play Games ğŸ®","Main Menu"}};
					response.put("questions",{q});
					return response;
				}
			}
		}
		// ---------- Normal MedTube flow ----------
		response = Map();
		response.put("action","context");
		response.put("context_id","MedTube");
		query = "Tamil Relaxing Songs";
		params = Map();
		params.put("part","snippet");
		params.put("type","video");
		params.put("maxResults","3");
		params.put("q",query);
		ytResp = invokeurl
		[
			url :"https://www.googleapis.com/youtube/v3/search"
			type :GET
			parameters:params
			connection:"youtube"
		];
		if(ytResp == null || ytResp.get("items") == null)
		{
			question = Map();
			question.put("name","done");
			question.put("replies",{"Sorry â€” couldn't fetch videos right now. Try again later."});
			question.put("suggestions",{"Back","Main Menu"});
			response.put("questions",{question});
			return response;
		}
		items = ytResp.get("items");
		videoCards = List();
		if(items != null && items.size() > 0)
		{
			for each  itm in items
			{
				if(itm != null)
				{
					vid = "";
					title = "YouTube Video";
					idObj = itm.get("id");
					if(idObj != null && idObj.get("videoId") != null)
					{
						vid = "" + idObj.get("videoId");
					}
					snippet = itm.get("snippet");
					if(snippet != null && snippet.get("title") != null)
					{
						title = "" + snippet.get("title");
					}
					if(vid != null && vid != "")
					{
						vmap = Map();
						vmap.put("type","video");
						vmap.put("text",title);
						vmap.put("url","https://www.youtube.com/watch?v=" + vid);
						videoCards.add(vmap);
					}
				}
			}
		}
		if(videoCards.size() == 0)
		{
			fallback1 = Map();
			fallback1.put("type","video");
			fallback1.put("text","Fallback â€” You are Perfect âœ¨");
			fallback1.put("url","https://www.youtube.com/watch?v=akaRg5C1VO8");
			fallback2 = Map();
			fallback2.put("type","video");
			fallback2.put("text","Fallback â€” It's okay not to be ok !!");
			fallback2.put("url","https://www.youtube.com/watch?v=SXGMWuJZeeo");
			videoCards.add(fallback1);
			videoCards.add(fallback2);
		}
		replies = List();
		replies.add("Enjoy these tracks:");
		for each  v in videoCards
		{
			replies.add(v);
		}
		response.put("action","context");
		response.put("context_id","depressedopt");
		question = Map();
		question.put("name","done");
		question.put("replies",replies);
		question.put("suggestions",{"Back","Main Menu"});
		response.put("questions",{question});
		return response;
	}
	else if(opt.containsIgnoreCase("Motivate me ğŸ’ª"))
	{
		response.put("action","context");
		response.put("context_id","quotegenerator");
		question = {"name":"quoteselect","replies":{"Here's a **Quote** that might help youğŸ¤— "},"suggestions":{"Go Ahead"}};
		response.put("questions",{question});
		return response;
	}
	else if(opt.containsIgnoreCase("Make me laugh ğŸ˜‚") || opt.containsIgnoreCase("More Jokes"))
	{
		response.put("action","context");
		response.put("context_id","jokegenerator");
		question = {"name":"jokeselect","replies":{"Okiee, Now I'm gonna **Show My Humorous SideğŸ˜**"},"suggestions":{"Go ahead"}};
		response.put("questions",{question});
		return response;
	}
	else if(opt.containsIgnoreCase("Main Menu"))
	{
		response.put("action","context");
		response.put("context_id","mainmenu");
		question = {"name":"select","replies":{"Hey buddy ğŸ™‹â€â™‚ï¸ Welcome to **MedKit** ğŸ©º! I'm here to guide you. Tell me what you'd like to do!"},"suggestions":{"MedKit Wellness Hub ğŸŒ¿","ğŸ‹ï¸ FitZone","ProcureX ğŸ›’","ğŸ’¬ Motivational Boost","ğŸ¤ Consult an Expert","ğŸ“ Help Desk"}};
		response.put("questions",{question});
		return response;
	}
	else if(opt.containsIgnoreCase("Tell me a story ğŸ“–"))
	{
		response.put("action","context");
		response.put("context_id","storygenerator");
		question = {"name":"storyselect","replies":{"Here's a **short story** for you âœ¨"},"suggestions":{"Go ahead"}};
		response.put("questions",{question});
		return response;
	}
	else if(opt.containsIgnoreCase("Show me a meme ğŸ–¼ï¸"))
	{
		response.put("action","context");
		response.put("context_id","memegenerator");
		question = {"name":"memeselect","replies":{"**Ready for a laugh?** ğŸ˜„"},"suggestions":{"Go ahead"}};
		response.put("questions",{question});
		return response;
	}
	// --- Mini-Games quick-entry (Spotify-style) ---
	else if(opt.containsIgnoreCase("Play Games ğŸ®") || opt.containsIgnoreCase("Games") || opt.containsIgnoreCase("Game"))
	{
		response.put("action","context");
		response.put("context_id","game_flow");
		// Redirect directly to your existing game flow
		q = {"name":"game_name","replies":{"ğŸ® Tell me the game you want to play","**Eg: subway surf, temple run, master chess...**"},"input":{"type":"name","placeholder":"Eg. Subway Surf"},"suggestions":{"Subway Surf","Temple Run","Shooting","Horror","Main Menu"}};
		response.put("questions",{q});
		return response;
	}
	else if(opt.containsIgnoreCase("Spotify ğŸµ"))
	{
		response.put("action","context");
		response.put("context_id","spotify_focus");
		q = {"name":"music_lang","replies":{"**ğŸ¶ Welcome to Mini-Spotify!** Just type any song or music vibe you want!\nLoFi, beats, romance, chill â€” Iâ€™ll find it."},"input":{"type":"name","placeholder":"Eg. Search any music..."},"suggestions":{"Tamil","Hindi","English","LoFi","Main Menu"}};
		response.put("questions",{q});
		return response;
	}
	else
	{
		response.put("action","context");
		response.put("context_id","main menu");
		question = {"name":"done","replies":{"It was nice chatting with you ğŸ˜Š Have a wonderful day! ğŸ‘‹"},"suggestions":{"Main Menu"}};
		response.put("questions",{question});
		return response;
	}
}
if(context_id != null && context_id.equals("jokegenerator"))
{
	joketrigger = "";
	if(answers.containsKey("jokeselect"))
	{
		joketrigger = answers.get("jokeselect").get("text").toLowerCase();
	}
	if(joketrigger.contains("Back") || joketrigger.contains("Back") || joketrigger.contains("back"))
	{
		response.put("action","context");
		response.put("context_id","depressedopt");
		question = {"name":"depressedOpt","replies":{"ğŸ˜Š Donâ€™t worry, your assistant is right here to lift you up ğŸ¤—"},"suggestions":{"Grab me some Books ğŸ“š","Spotify ğŸµ","Motivate me ğŸ’ª","Make me laugh ğŸ˜‚","MedTube ğŸ¥","Show me a meme ğŸ–¼ï¸","Tell me a story ğŸ“–","Play Games ğŸ®","Main Menu"}};
		response.put("questions",{question});
		return response;
	}
	if(joketrigger.contains("go") || joketrigger.contains("one more") || joketrigger.contains("another"))
	{
		jokeText = "";
		try 
		{
			jokeResp = invokeurl
			[
				url :"https://official-joke-api.appspot.com/random_joke"
				type :GET
			];
			if(jokeResp != null && jokeResp.get("setup") != null)
			{
				jokeText = jokeResp.get("setup") + "\n\n" + jokeResp.get("punchline");
			}
			else
			{
				jokeText = "Hmmâ€¦ couldnâ€™t get a joke ğŸ˜… Try again!";
			}
		}
		catch (e)
		{
			jokeText = "API failed ğŸ˜©\nBut here's one:\nWhy donâ€™t scientists trust atoms? Because they make up everything!";
		}
		question = {"name":"jokeselect","replies":{jokeText},"suggestions":{"One more","Main Menu","Back"}};
		respMap = Map();
		respMap.put("action","context");
		respMap.put("context_id","jokegenerator");
		respMap.put("questions",{question});
		return respMap;
	}
}
if(context_id.equals("gbooks"))
{
	genre = answers.get("gbook").get("text");
	genre = genre.getAlpha();
	if(genre.equals(""))
	{
		response.put("action","context");
		response.put("context_id","depressedopt");
		q = Map();
		q.put("name","depressedOpt");
		q.put("replies",{"Please enter only alphabets ğŸ˜•"});
		q.put("suggestions",{"Retry","No Thanks"});
		response.put("questions",{q});
		return response;
	}
	api = invokeurl
	[
		url :"https://www.googleapis.com/books/v1/volumes?q=" + genre
		type :GET
		connection:"googlebooks"
	];
	items = List();
	try 
	{
		items = api.get("items");
	}
	catch (e)
	{
		items = List();
	}
	readIcon = "https://cdn-icons-png.flaticon.com/512/10/10919.png";
	buyIcon = "https://image.flaticon.com/icons/png/512/126/126083.png";
	cards = List();
	index = 0;
	for each  book in items
	{
		if(index < 2)
		{
			vol = Map();
			sale = Map();
			try 
			{
				vol = book.get("volumeInfo");
			}
			catch (ve)
			{
				vol = Map();
			}
			try 
			{
				sale = book.get("saleInfo");
			}
			catch (se)
			{
				sale = Map();
			}
			title = "";
			try 
			{
				if(vol.get("title") != null)
				{
					title = "" + vol.get("title");
				}
			}
			catch (te)
			{
				title = "";
			}
			if(title == "")
			{
				title = "Untitled";
			}
			authorStr = "Unknown Author";
			try 
			{
				authObj = vol.get("authors");
				if(authObj != null)
				{
					tempA = List();
					for each  aa in authObj
					{
						if(aa != null)
						{
							tempA.add("" + aa);
						}
					}
					if(tempA.size() > 0)
					{
						joinedA = "";
						jj = 0;
						for each  sA in tempA
						{
							if(jj == 0)
							{
								joinedA = "" + sA;
							}
							else
							{
								joinedA = joinedA + ", " + sA;
							}
							jj = jj + 1;
						}
						authorStr = joinedA;
					}
				}
			}
			catch (ae)
			{
				authorStr = "Unknown Author";
			}
			thumb = "";
			try 
			{
				thumb = vol.get("imageLinks").get("thumbnail");
			}
			catch (ime)
			{
				thumb = "";
			}
			infoLink = "";
			try 
			{
				infoLink = "" + vol.get("infoLink");
			}
			catch (il)
			{
				infoLink = "";
			}
			if(infoLink == "")
			{
				infoLink = "https://www.google.com/search?q=" + title;
			}
			buyLink = "";
			try 
			{
				buyLink = "" + sale.get("buyLink");
			}
			catch (bl)
			{
				buyLink = "";
			}
			if(buyLink == "")
			{
				buyLink = "https://www.google.com/search?q=buy+" + title;
			}
			linksList = List();
			readMap = Map();
			readMap.put("url",infoLink);
			readMap.put("text","Read Now");
			readMap.put("icon","https://cdn-icons-png.flaticon.com/512/10/10919.png");
			linksList.add(readMap);
			buyMap = Map();
			buyMap.put("url",buyLink);
			buyMap.put("text","Buy Now");
			buyMap.put("icon","https://image.flaticon.com/icons/png/512/126/126083.png");
			linksList.add(buyMap);
			card = Map();
			card.put("type","links");
			card.put("text",title + " by " + authorStr + " [English].");
			card.put("image",thumb);
			card.put("image_position","fit");
			card.put("links",linksList);
			cards.add(card);
		}
		index = index + 1;
	}
	if(cards.size() == 0)
	{
		response.put("action","context");
		response.put("context_id","depressedopt");
		q = Map();
		q.put("name","depressedOpt");
		q.put("replies",{"No books found for: " + genre});
		q.put("suggestions",{"Retry","No Thanks"});
		response.put("questions",{q});
		return response;
	}
	response.put("action","context");
	response.put("context_id","depressedopt");
	q = Map();
	q.put("name","depressedOpt");
	q.put("replies",cards);
	sugs = List();
	sugs.add("Search More");
	sugs.add("Main Menu");
	sugs.add("Back");
	q.put("suggestions",sugs);
	response.put("questions",{q});
	return response;
}
if(context_id != null && context_id.equals("spotify_focus"))
{
	music = ifnull(answers.get("music_lang").get("text"),"").trim();
	info "SPOTIFY >>> userText = " + music;
	if(music.equalsIgnoreCase("Search More"))
	{
		response.put("action","context");
		response.put("context_id","spotify_focus");
		q = {"name":"music_lang","replies":{"**ğŸ¶ Welcome to Mini-Spotify!** Just type any song or music vibe you want!\nLoFi, beats, romance,chill â€” Iâ€™ll find it."},"input":{"type":"name","placeholder":"Eg. Search any music..."},"suggestions":{"Tamil","Hindi","English","LoFi","Main Menu"}};
		response.put("questions",{q});
		return response;
	}
	if(music.equalsIgnoreCase("Main Menu") || music.equalsIgnoreCase("Mainmenu"))
	{
		response.put("action","context");
		response.put("context_id","mainmenu");
		question = {"name":"select","replies":{"Hey buddy ğŸ™‹â€â™‚ï¸ Welcome to **MedKit** ğŸ©º! I'm here to guide you. Tell me what you'd like to do!"},"suggestions":{"MedKit Wellness Hub ğŸŒ¿","ğŸ‹ï¸ FitZone","ProcureX ğŸ›’","ğŸ’¬ Motivational Boost","ğŸ¤ Consult an Expert","ğŸ“ Help Desk"}};
		response.put("questions",{question});
		return response;
	}
	if(music.equalsIgnoreCase("Back") || music.equalsIgnoreCase("back"))
	{
		response.put("action","context");
		response.put("context_id","depressedopt");
		question = {"name":"depressedOpt","replies":{"ğŸ˜Š Donâ€™t worry, your assistant is right here to lift you up ğŸ¤—"},"suggestions":{"Grab me some Books ğŸ“š","Spotify ğŸµ","Motivate me ğŸ’ª","Make me laugh ğŸ˜‚","MedTube ğŸ¥","Show me a meme ğŸ–¼ï¸","Tell me a story ğŸ“–","Play Games ğŸ®","Main Menu"}};
		response.put("questions",{question});
		return response;
	}
	tokenResp = invokeurl
	[
		url :"https://accounts.spotify.com/api/token"
		type :POST
		parameters:{"grant_type":"client_credentials"}
		connection:"spotify_conn"
	];
	accessToken = ifnull(tokenResp.get("access_token"),"");
	info "SPOTIFY >>> token = " + if(accessToken != "","RECEIVED","EMPTY");
	if(accessToken == "")
	{
		response.put("action","reply");
		response.put("replies",{"Sorry, I couldn't connect to Spotify right now. Please try again later."});
		return response;
	}
	searchQuery = music + " songs";
	encodedQuery = searchQuery.replaceAll(" ","%20");
	searchUrl = "https://api.spotify.com/v1/search?q=" + encodedQuery + "&type=track&limit=5";
	info "SPOTIFY >>> URL = " + searchUrl;
	searchResp = invokeurl
	[
		url :searchUrl
		type :GET
		headers:{"Authorization":"Bearer " + accessToken}
	];
	items = List();
	try 
	{
		tracks = searchResp.get("tracks");
		if(tracks != null && tracks.containsKey("items"))
		{
			items = tracks.get("items");
		}
	}
	catch (e)
	{
		items = List();
	}
	cards = List();
	index = 0;
	spotifyIcon = "https://upload.wikimedia.org/wikipedia/commons/thumb/1/19/Spotify_logo_without_text.svg/2048px-Spotify_logo_without_text.svg.png";
	for each  track in items
	{
		if(index < 2)
		{
			title = "Untitled";
			try 
			{
				if(track.get("name") != null)
				{
					title = "" + track.get("name");
				}
			}
			catch (te)
			{
				title = "Untitled";
			}
			artistStr = "Unknown Artist";
			try 
			{
				artList = track.get("artists");
				if(artList != null)
				{
					tempA = List();
					for each  aa in artList
					{
						if(aa != null && aa.get("name") != null)
						{
							tempA.add("" + aa.get("name"));
						}
					}
					if(tempA.size() > 0)
					{
						joinTxt = "";
						ai = 0;
						for each  an in tempA
						{
							if(ai == 0)
							{
								joinTxt = "" + an;
							}
							else
							{
								joinTxt = joinTxt + ", " + an;
							}
							ai = ai + 1;
						}
						artistStr = joinTxt;
					}
				}
			}
			catch (ae)
			{
				artistStr = "Unknown Artist";
			}
			imgUrl = "";
			try 
			{
				album = track.get("album");
				if(album != null && album.containsKey("images"))
				{
					imgList = album.get("images");
					if(imgList != null && imgList.size() > 0)
					{
						imgUrl = ifnull(imgList.get(0).get("url"),"");
					}
				}
			}
			catch (ie)
			{
				imgUrl = "";
			}
			trackUrl = "";
			try 
			{
				ext = track.get("external_urls");
				if(ext != null && ext.containsKey("spotify"))
				{
					trackUrl = ifnull(ext.get("spotify"),"");
				}
			}
			catch (le)
			{
				trackUrl = "";
			}
			if(trackUrl == "")
			{
				trackUrl = "https://open.spotify.com/search/" + encodedQuery;
			}
			linksList = List();
			playMap = Map();
			playMap.put("url",trackUrl);
			playMap.put("text","Play on Spotify");
			playMap.put("icon",spotifyIcon);
			linksList.add(playMap);
			card = Map();
			card.put("type","links");
			card.put("text",title + " by " + artistStr + " [Spotify].");
			card.put("image",imgUrl);
			card.put("image_position","fit");
			card.put("links",linksList);
			cards.add(card);
		}
		index = index + 1;
	}
	if(cards.size() == 0)
	{
		response.put("action","reply");
		response.put("replies",{"No results found for: " + music});
		response.put("suggestions",{"Search More","Main Menu","Back"});
		return response;
	}
	response.put("action","context");
	response.put("context_id","spotify_focus");
	q = Map();
	q.put("name","music_lang");
	q.put("replies",cards);
	q.put("suggestions",{"Search More","Main Menu","Back"});
	response.put("questions",{q});
	return response;
}
if(context_id != null && context_id.equals("memegenerator"))
{
	memetrigger = "";
	if(answers.containsKey("memeselect"))
	{
		memetrigger = answers.get("memeselect").get("text").toLowerCase();
	}
	if(memetrigger.contains("BACK") || memetrigger.contains("Back") || memetrigger.contains("back"))
	{
		response.put("action","context");
		response.put("context_id","depressedopt");
		question = {"name":"depressedOpt","replies":{"ğŸ˜Š Donâ€™t worry, your assistant is right here to lift you up ğŸ¤—"},"suggestions":{"Grab me some Books ğŸ“š","Spotify ğŸµ","Motivate me ğŸ’ª","Make me laugh ğŸ˜‚","MedTube ğŸ¥","Show me a meme ğŸ–¼ï¸","Tell me a story ğŸ“–","Play Games ğŸ®","Main Menu"}};
		response.put("questions",{question});
		return response;
	}
	if(memetrigger.contains("go") || memetrigger.contains("go ahead") || memetrigger.contains("memegenerate") || memetrigger.contains("one more") || memetrigger.contains("another"))
	{
		memeText = "";
		title = "";
		imageUrl = "";
		try 
		{
			memeResp = invokeurl
			[
				url :"https://meme-api.com/gimme"
				type :GET
			];
			if(memeResp != null && memeResp.get("url") != null)
			{
				title = "" + memeResp.get("title");
				imageUrl = "" + memeResp.get("url");
				memeText = title + "\n" + imageUrl;
			}
			else
			{
				memeText = "Hmmâ€¦ couldnâ€™t fetch a meme ğŸ˜… Try again!";
			}
		}
		catch (e)
		{
			memeText = "API failed ğŸ˜©\nBut here's a classic: Grumpy Cat â€” https://i.imgur.com/4M7IWwP.jpg";
		}
		question = {"name":"memeselect","replies":{memeText},"suggestions":{"One more","Back"}};
		respMap = Map();
		respMap.put("action","context");
		respMap.put("context_id","memegenerator");
		respMap.put("questions",{question});
		return respMap;
	}
}
if(context_id != null && context_id.equals("quotegenerator"))
{
	quotetrigger = "";
	if(answers != null && answers.containsKey("quoteselect"))
	{
		qs = answers.get("quoteselect");
		if(qs != null && qs.get("text") != null)
		{
			quotetrigger = qs.get("text").toLowerCase();
		}
	}
	if(quotetrigger.contains("Back") || quotetrigger.contains("BACK") || quotetrigger.contains("back"))
	{
		response.put("action","context");
		response.put("context_id","depressedopt");
		question = {"name":"depressedOpt","replies":{"ğŸ˜Š Donâ€™t worry, your assistant is right here to lift you up ğŸ¤—"},"suggestions":{"Grab me some Books ğŸ“š","Spotify ğŸµ","Motivate me ğŸ’ª","Make me laugh ğŸ˜‚","MedTube ğŸ¥","Show me a meme ğŸ–¼ï¸","Tell me a story ğŸ“–","Play Games ğŸ®","Main Menu"}};
		response.put("questions",{question});
		return response;
	}
	if(quotetrigger.contains("go ahead") || quotetrigger.contains("quote") || quotetrigger.contains("go") || quotetrigger.contains("one more") || quotetrigger.contains("another"))
	{
		quoteText = "";
		try 
		{
			quoteResp = invokeurl
			[
				url :"https://zenquotes.io/api/random"
				type :GET
			];
			if(quoteResp != null && quoteResp.size() > 0)
			{
				q = quoteResp.get(0);
				if(q != null && q.get("q") != null && q.get("a") != null)
				{
					quoteText = "\"" + q.get("q") + "\" â€” " + q.get("a");
				}
				else
				{
					quoteText = "You are capable of amazing things âœ¨";
				}
			}
			else
			{
				quoteText = "Stay strong. Better days are coming ğŸ¤";
			}
		}
		catch (e)
		{
			quoteText = "The only person you should try to be better than is the one you were yesterday. ğŸŒŸ";
		}
		question = {"name":"quoteselect","replies":{quoteText},"suggestions":{"One more","Back"}};
		respMap = Map();
		respMap.put("action","context");
		respMap.put("context_id","quotegenerator");
		respMap.put("questions",{question});
		return respMap;
	}
}
if(context_id != null && context_id.equals("storygenerator"))
{
	storytrigger = "";
	if(answers != null && answers.containsKey("storyselect"))
	{
		ss = answers.get("storyselect");
		if(ss != null && ss.get("text") != null)
		{
			storytrigger = ss.get("text").toLowerCase();
		}
	}
	if(storytrigger.contains("Back") || storytrigger.contains("back"))
	{
		response.put("action","context");
		response.put("context_id","depressedopt");
		question = {"name":"depressedOpt","replies":{"ğŸ˜Š Donâ€™t worry, your assistant is right here to lift you up ğŸ¤—"},"suggestions":{"Grab me some Books ğŸ“š","Spotify ğŸµ","Motivate me ğŸ’ª","Make me laugh ğŸ˜‚","MedTube ğŸ¥","Show me a meme ğŸ–¼ï¸","Tell me a story ğŸ“–","Play Games ğŸ®","Main Menu"}};
		response.put("questions",{question});
		return response;
	}
	if(storytrigger.contains("go ahead") || storytrigger.contains("storygenerate") || storytrigger.contains("go") || storytrigger.contains("one more") || storytrigger.contains("another"))
	{
		respMap = Map();
		storyText = "";
		try 
		{
			storyResp = invokeurl
			[
				url :"https://shortstories-api.onrender.com/"
				type :GET
			];
			if(storyResp != null && storyResp.get("story") != null)
			{
				title = "";
				author = "";
				body = "";
				moral = "";
				if(storyResp.get("title") != null)
				{
					title = "" + storyResp.get("title");
				}
				if(storyResp.get("author") != null)
				{
					author = "" + storyResp.get("author");
				}
				if(storyResp.get("story") != null)
				{
					body = "" + storyResp.get("story");
				}
				if(storyResp.get("moral") != null)
				{
					moral = "" + storyResp.get("moral");
				}
				display = "";
				if(title != null && title.trim() != "")
				{
					display = display + title;
					if(author != null && author.trim() != "")
					{
						display = display + " â€” " + author;
					}
					display = display + "\n\n";
				}
				if(body != null)
				{
					display = display + body;
				}
				if(moral != null && moral.trim() != "")
				{
					display = display + "\n\nMoral: " + moral;
				}
				storyText = display;
			}
			else
			{
				storyText = "Hmmâ€¦ couldnâ€™t get a story ğŸ˜… Try again!";
			}
		}
		catch (e)
		{
			storyText = "A little bird spent the night on a small windowsill and by morning had taught a lonely child to whistle again.";
		}
		question = Map();
		question.put("name","storyselect");
		question.put("replies",{storyText});
		question.put("suggestions",{"One more","Back"});
		respMap.put("action","context");
		respMap.put("context_id","storygenerator");
		respMap.put("questions",{question});
		return respMap;
	}
}
portalId = "trycatchus";
API_KEY_PLACEHOLDER = "5b95bfaa-d69d-11f0-a6b2-0200cd936042";
// 2factor key (replace)
CAL_API_KEY = "Bearer cal_live_d9e30fb446552d87e771b5f3d8ba7cf1";
// cal.com key (replace)
RESEND_MIN_SECONDS = 15;
MAX_OTP_ATTEMPTS_LOCAL = 5;
if(context_id != null && (context_id.equalsIgnoreCase("consultopt") || context_id.equalsIgnoreCase("consultopt")))
{
	trig = "";
	if(answers.containsKey("consultopt"))
	{
		trig = ifnull(answers.get("consultopt").get("text"),"");
	}
	trigLower = trig.toLowerCase();
	if(trigLower.equalsIgnoreCase("ğŸ“… make an appointment") || trigLower.equalsIgnoreCase("Make an Appointment") || trigLower.contains("make an appointment"))
	{
		response.put("action","context");
		response.put("context_id","consult_schedule_name");
		q = Map();
		q.put("name","sched_name");
		q.put("replies",{"ğŸ“… Great! Letâ€™s book your appointment.\nPlease share your **Name** so we can personalize your booking."});
		q.put("input",{"type":"name","placeholder":"Enter your name","error":{"Please enter a valid name"}});
		response.put("questions",{q});
		return response;
	}
	if(trigLower.equalsIgnoreCase("â„¹ï¸ about") || trigLower.equalsIgnoreCase("about") || trigLower.contains("About"))
	{
		response.put("action","context");
		response.put("context_id","consultopt");
		text = "â„¹ï¸ **About MedKit Appointments**\n\n**Step 1: Make An Appointment**\n\nâ€¢ Enter your **Name**\nâ€¢ Verify your **Email (OTP)**\nâ€¢ Verify your **Phone Number**\nâ€¢ Select your preferred **Date & Time**\nâ€¢ Your appointment will be **successfully booked**\n\n**Step 2: My Appointments**\n\nâ€¢ Open **My Appointments**\nâ€¢ Verify using **Name, Email (OTP), and Phone (OTP)**\nâ€¢ View your **Scheduled Appointments**\nâ€¢ **Reschedule â°** or **Cancel âŒ** if needed\nğŸ“ Our **MedKit Team** will contact you via **Email** after verification.\n\nâ¤ï¸ **Thank You For Choosing MedKit â€” Weâ€™re Always Here To Support You!**";
		q = Map();
		q.put("name","consultopt");
		q.put("replies",{text});
		q.put("suggestions",{"Back","ğŸ“… Make an Appointment","ğŸ“˜ My Appointments","Main Menu"});
		response.put("questions",{q});
		return response;
	}
	if(trigLower.equalsIgnoreCase("Back") || trigLower.equalsIgnoreCase("back"))
	{
		response.put("action","context");
		response.put("context_id","consultopt");
		question = {"name":"consultopt","replies":{"ğŸ˜ Welcome to **MedKit Expert Help!**"},"suggestions":{"â„¹ï¸ About","ğŸ“… Make an Appointment","ğŸ“˜ My Appointments","Main Menu"}};
		response.put("questions",{question});
		return response;
	}
	if(trigLower.equalsIgnoreCase("ğŸ“˜ my appointments") || trigLower.equalsIgnoreCase("my appointments") || trigLower.contains("my appointments"))
	{
		existingName = "";
		try 
		{
			tmp = zoho.salesiq.visitorsession.get(portalId,"nf_name");
			if(tmp.containsKey("data"))
			{
				existingName = ifnull(tmp.get("data").get("nf_name"),"");
			}
		}
		catch (e)
		{
			existingName = "";
		}
		if(existingName == null || existingName.trim() == "")
		{
			response.put("action","context");
			response.put("context_id","my_appointments_name");
			// ask name step
			q = Map();
			q.put("name","nf_name");
			q.put("replies",{"ğŸ“… To fetch appointments we need to verify you. What's your **Name?**"});
			q.put("input",{"type":"name","placeholder":"Enter your name"});
			q.put("suggestions",{"Main Menu"});
			response.put("questions",{q});
			return response;
		}
		else
		{
			nfEmail = "";
			try 
			{
				tmp2 = zoho.salesiq.visitorsession.get(portalId,"nf_email");
				if(tmp2.containsKey("data"))
				{
					nfEmail = ifnull(tmp2.get("data").get("nf_email"),"");
				}
			}
			catch (e)
			{
				nfEmail = "";
			}
			if(nfEmail == null || nfEmail.trim() == "")
			{
				response.put("action","context");
				response.put("context_id","my_appointments_email");
				q = Map();
				q.put("name","nf_email");
				q.put("replies",{"ğŸ“§ Please enter your **Email** so I can send a verification OTP."});
				q.put("input",{"type":"email","placeholder":"example@gmail.com"});
				q.put("suggestions",{"Main Menu"});
				response.put("questions",{q});
				return response;
			}
			else
			{
				response.put("action","context");
				response.put("context_id","my_appointments_phone_collect");
				q = Map();
				q.put("name","sched_phone");
				q.put("replies",{"ğŸ“² Please enter your **Phone Number** to verify (example: 9198xxxxxxxx)."});
				q.put("input",{"type":"name","placeholder":"9198xxxxxxxx"});
				q.put("suggestions",{"Main Menu"});
				response.put("questions",{q});
				return response;
			}
		}
	}
}
if(context_id != null && context_id.equals("my_appointments_name") && answers.containsKey("nf_name") && !answers.containsKey("nf_email"))
{
	uname = ifnull(answers.get("nf_name").get("text"),"Friend");
	tmpMap = Map();
	tmpMap.put("nf_name",uname);
	try 
	{
		zoho.salesiq.visitorsession.set(portalId,tmpMap);
	}
	catch (e)
	{
	}
	response.put("action","context");
	response.put("context_id","my_appointments_email");
	q = Map();
	q.put("name","nf_email");
	q.put("replies",{"Hi **" + uname + "**, please enter your **Email** so I can send your OTP ğŸ”."});
	inputMap = Map();
	inputMap.put("type","email");
	inputMap.put("placeholder","medkit@gmail.com");
	inputMap.put("error",{"Enter a valid email"});
	q.put("input",inputMap);
	response.put("questions",{q});
	return response;
}
if(context_id != null && context_id.equals("my_appointments_email") && answers.containsKey("nf_email") && !answers.containsKey("nf_otp"))
{
	uname = "";
	try 
	{
		tmpN = zoho.salesiq.visitorsession.get(portalId,"nf_name");
		if(tmpN.containsKey("data"))
		{
			uname = ifnull(tmpN.get("data").get("nf_name"),"Customer");
		}
	}
	catch (e)
	{
		uname = "Customer";
	}
	uemail = ifnull(answers.get("nf_email").get("text"),"");
	isValidEmail = true;
	if(uemail == null || uemail.trim() == "")
	{
		isValidEmail = false;
	}
	else if(uemail.indexOf("@") == -1 || uemail.indexOf(".") == -1)
	{
		isValidEmail = false;
	}
	if(!isValidEmail)
	{
		response.put("action","context");
		response.put("context_id","my_appointments_email");
		q = Map();
		q.put("name","nf_email");
		q.put("replies",{"âŒ That does not look like a valid email.","Hi " + uname + ", please enter a **Correct Email Address** (example: user@gmail.com) so I can send your OTP ğŸ”."});
		inputMap = Map();
		inputMap.put("type","email");
		inputMap.put("placeholder","medkit@gmail.com");
		inputMap.put("error",{"Enter a valid email"});
		q.put("input",inputMap);
		response.put("questions",{q});
		return response;
	}
	// Generate OTP and save to session (ProcureX exact keys)
	otpNum = randomNumber(100000,999999);
	otpStr = otpNum.toString();
	sessMap = Map();
	sessMap.put("nf_otp_value",otpStr);
	sessMap.put("nf_name",uname);
	sessMap.put("nf_email",uemail);
	sessMap.put("nf_otp_sent_ts",zoho.currenttime);
	try 
	{
		sessMap.put("nf_otp_attempts",0);
	}
	catch (e)
	{
	}
	try 
	{
		zoho.salesiq.visitorsession.set(portalId,sessMap);
	}
	catch (e)
	{
	}
	sendmail
	[
		from :zoho.adminuserid
		to :uemail
		subject :"MedKit - Here is your OTP"
		message :"<div style='background:#f7f7fb;padding:32px 0;font-family:Arial,Helvetica,sans-serif;'><div style='max-width:600px;margin:0 auto;background:#ffffff;border-radius:12px;padding:32px 28px;border:1px solid #e5e7eb;text-align:center;'><img src='https://strange-aqua-5yfklivwfj-muznn4xg3b.edgeone.dev/MEDOOO.jpg' alt='MedKit' style='width:60px;margin-bottom:12px;'><h2 style='color:#111827;margin:0 0 12px 0;font-weight:700;'>MedKit Appointment Verification</h2><p style='color:#4b5563;font-size:14px;margin:0 0 22px 0;'>We received a request to verify your appointment booking in MedKit. Please enter the verification code below in the chatbot to continue confirming your appointment.</p><div style='background:#f3f4f6;padding:18px 0;font-size:32px;font-weight:700;border-radius:10px;color:#111827;margin-bottom:22px;'>" + otpStr + "</div><p style='color:#6b7280;font-size:12px;margin-bottom:22px;'>If you did not request an appointment, please ignore this email. This OTP is valid for 10 minutes.</p><hr style='border:none;border-top:1px solid #e5e7eb;margin:24px 0;'><p style='font-size:12px;color:#9ca3af;'>MedKit â€“ Smart Appointment Booking Made Simple ğŸ©ºğŸ“…</p></div></div>"
	]
	response.put("action","context");
	response.put("context_id","my_appointments_email_verify");
	q = Map();
	q.put("name","nf_otp");
	q.put("replies",{"We have sent a **6-digit** OTP to " + uemail + ". Please enter it below ğŸ”:"});
	inputMap = Map();
	inputMap.put("type","name");
	inputMap.put("placeholder","Enter OTP");
	q.put("input",inputMap);
	q.put("suggestions",{"Resend OTP","Try Again","Main Menu"});
	response.put("questions",{q});
	return response;
}
if(context_id != null && context_id.equals("my_appointments_email_verify") && answers.containsKey("nf_otp"))
{
	enteredOtp = answers.get("nf_otp").get("text");
	realOtp = "";
	try 
	{
		vsResp = zoho.salesiq.visitorsession.get(portalId,"nf_otp_value");
		if(vsResp.containsKey("data"))
		{
			realOtp = ifnull(vsResp.get("data").get("nf_otp_value"),"");
		}
	}
	catch (e)
	{
		realOtp = "";
	}
	attempts = 0;
	try 
	{
		tmpA = zoho.salesiq.visitorsession.get(portalId,"nf_otp_attempts");
		if(tmpA.containsKey("data"))
		{
			attempts = ifnull(tmpA.get("data").get("nf_otp_attempts"),0).toLong();
		}
	}
	catch (e)
	{
		attempts = 0;
	}
	if(enteredOtp != realOtp)
	{
		// increment attempts and prompt again (ProcureX style)
		try 
		{
			tmap = Map();
			tmap.put("nf_otp_attempts",attempts + 1);
			zoho.salesiq.visitorsession.set(portalId,tmap);
		}
		catch (e)
		{
		}
		response.put("action","context");
		response.put("context_id","my_appointments_email_verify");
		q = Map();
		q.put("name","nf_otp");
		q.put("replies",{"âŒ That OTP is **Incorrect**. Please enter the correct 6-digit OTP sent to your email."});
		inputMap = Map();
		inputMap.put("type","name");
		inputMap.put("placeholder","Enter OTP again");
		q.put("input",inputMap);
		q.put("suggestions",{"Try Again","Main Menu"});
		response.put("questions",{q});
		return response;
	}
	try 
	{
		tmpv = Map();
		tmpv.put("nf_otp_value","");
		tmpv.put("nf_otp_attempts",0);
		tmpv.put("nf_email_verified",true);
		zoho.salesiq.visitorsession.set(portalId,tmpv);
	}
	catch (e)
	{
	}
	response.put("action","context");
	response.put("context_id","my_appointments_phone_collect");
	q = Map();
	q.put("name","sched_phone");
	q.put("replies",{"ğŸ‰ Email verified **Successfully!**\nPlease enter your **Phone Number** to receive a verification code via **SMS or Call** ğŸ“²."});
	q.put("input",{"type":"name","placeholder":"9198xxxxxxxx"});
	q.put("suggestions",{"Main Menu"});
	response.put("questions",{q});
	return response;
}
if(context_id != null && context_id.equals("my_appointments_phone_collect") && answers.containsKey("sched_phone") && !answers.containsKey("sched_otp"))
{
	phoneRaw = ifnull(answers.get("sched_phone").get("text"),"").trim();
	phone = phoneRaw.replaceAll("\\+","").replaceAll("\\s+","");
	if(phone == null || phone == "" || phone.length() < 10)
	{
		response.put("action","context");
		response.put("context_id","my_appointments_phone_collect");
		q = Map();
		q.put("name","sched_phone");
		q.put("replies",{"âš ï¸ Oops! Please enter a correct **Phone Number** with at least 10 digits"});
		q.put("input",{"type":"name"});
		q.put("suggestions",{"Try Again","Main Menu"});
		response.put("questions",{q});
		return response;
	}
	// anti-resend check (consult logic)
	lastTs = 0;
	try 
	{
		vsResp = zoho.salesiq.visitorsession.get(portalId,"consult_otp_sent_ts");
		if(vsResp.containsKey("data"))
		{
			rawVal = ifnull(vsResp.get("data").get("consult_otp_sent_ts"),"");
			if(rawVal != "")
			{
				lastTs = rawVal.toLong();
			}
		}
	}
	catch (e)
	{
		lastTs = 0;
	}
	now = zoho.currenttime.toLong();
	if(lastTs != 0 && now - lastTs < RESEND_MIN_SECONDS)
	{
		response.put("action","context");
		response.put("context_id","my_appointments_phone_collect");
		q = Map();
		q.put("name","sched_phone");
		q.put("replies",{"â³ Please wait a **Few Seconds** before requesting OTP again."});
		q.put("suggestions",{"Try Again","Main Menu"});
		response.put("questions",{q});
		return response;
	}
	// call 2factor.in AUTOGEN (consult exact)
	sendUrl = "https://2factor.in/API/V1/" + API_KEY_PLACEHOLDER + "/SMS/" + phone + "/AUTOGEN";
	sendResp = Map();
	try 
	{
		raw = getUrl(sendUrl);
		try 
		{
			sendResp = raw.toMap();
		}
		catch (e)
		{
			sendResp = raw;
		}
	}
	catch (e)
	{
		sendResp = Map();
		sendResp.put("Status","Error");
		sendResp.put("Message","Failed to call OTP API: " + e.toString());
	}
	success = false;
	details = "";
	try 
	{
		if(sendResp != null)
		{
			tmp = sendResp;
			try 
			{
				tmp = tmp.toMap();
			}
			catch (innerEx)
			{
				tmp = tmp;
			}
			sendResp = tmp;
			if(tmp.containsKey("Status"))
			{
				st = tmp.get("Status").toString().toLowerCase();
				if(st.equals("success"))
				{
					success = true;
				}
			}
			if(!success && tmp.containsKey("status"))
			{
				st2 = tmp.get("status").toString().toLowerCase();
				if(st2.equals("success"))
				{
					success = true;
				}
			}
			if(tmp.containsKey("Details"))
			{
				details = tmp.get("Details");
				try 
				{
					tmpMap = Map();
					tmpMap.put("consult_otp_session",details);
					zoho.salesiq.visitorsession.set(portalId,tmpMap);
				}
				catch (e2)
				{
				}
			}
		}
	}
	catch (e)
	{
	}
	if(success)
	{
		try 
		{
			tmpTimeMap = Map();
			tmpTimeMap.put("consult_otp_sent_ts",zoho.currenttime);
			zoho.salesiq.visitorsession.set(portalId,tmpTimeMap);
		}
		catch (e)
		{
		}
		try 
		{
			tmpAttemptsMap = Map();
			tmpAttemptsMap.put("consult_otp_attempts",0);
			zoho.salesiq.visitorsession.set(portalId,tmpAttemptsMap);
		}
		catch (e)
		{
		}
		try 
		{
			tmp3 = Map();
			tmp3.put("consult_phone",phone);
			zoho.salesiq.visitorsession.set(portalId,tmp3);
		}
		catch (e)
		{
		}
		response.put("action","context");
		response.put("context_id","consult_verify_otp");
		// reuse consult verify context
		q = Map();
		q.put("name","sched_otp");
		q.put("replies",{"ğŸ“ OTP sent to **" + phone + "**. Please enter the 6-digit OTP you received."});
		q.put("input",{"type":"name","placeholder":"Enter OTP"});
		q.put("suggestions",{"Try Again","Main Menu"});
		response.put("questions",{q});
		return response;
	}
	else
	{
		errMsg = "";
		try 
		{
			errMsg = sendResp.get("Message");
		}
		catch (e)
		{
			errMsg = sendResp.toString();
		}
		response.put("action","context");
		response.put("context_id","consult_phone");
		q = Map();
		q.put("name","sched_phone");
		q.put("replies",{"âŒ Could not send OTP: " + errMsg + "\nWould you like to try again?"});
		q.put("suggestions",{"Try Again","Main Menu"});
		response.put("questions",{q});
		return response;
	}
}
if(context_id != null && context_id.equals("consult_verify_otp") && answers.containsKey("sched_otp"))
{
	userOtp = ifnull(answers.get("sched_otp").get("text"),"").trim();
	if(userOtp == "Refresh" || userOtp == "refresh")
	{
		response = Map();
		userEmail = "";
		try 
		{
			e = zoho.salesiq.visitorsession.get(portalId,"nf_email");
			if(e.containsKey("data"))
			{
				userEmail = ifnull(e.get("data").get("nf_email"),"");
			}
		}
		catch (e)
		{
		}
		if(userEmail == "")
		{
			response.put("action","context");
			response.put("context_id","consultopt");
			return response;
		}
		bookingURL = "https://api.cal.com/v2/bookings?email=" + userEmail;
		bookingResp = invokeurl
		[
			url :bookingURL
			type :GET
			headers:{"Authorization":CAL_API_KEY}
		];
		if(bookingResp.get("status") != "success")
		{
			response.put("action","reply");
			response.put("replies",{"âŒ Could not fetch your appointments."});
			return response;
		}
		bookings = bookingResp.get("data").get("bookings");
		myBookings = List();
		for each  b in bookings
		{
			attendees = ifnull(b.get("attendees"),List());
			for each  a in attendees
			{
				if(a.get("email") == userEmail)
				{
					myBookings.add(b);
				}
			}
		}
		if(myBookings.isEmpty())
		{
			response.put("action","reply");
			response.put("replies",{"ğŸ˜• No appointments found for *" + userEmail + "*"});
			sugs = List();
			sugs.add("Main Menu");
			response.put("suggestions",sugs);
			return response;
		}
		finalMsg = "ğŸ“… *Your Appointments*\n\n";
		count = 1;
		cleanEmail = userEmail.replaceAll(" ","%20");
		cards = List();
		staticImage = "https://image2url.com/images/1765648240188-21fc1436-74ed-446e-a15b-f4bca8e87299.jpg";
		monthNames = {"Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"};
		for each  booking in myBookings
		{
			title = booking.get("title");
			startISO = booking.get("startTime");
			endISO = booking.get("endTime");
			year = startISO.substring(0,4).toLong();
			month = startISO.substring(5,7).toLong();
			day = startISO.substring(8,10).toLong();
			// Parse time parts
			hour = startISO.substring(11,13).toLong();
			minute = startISO.substring(14,16).toLong();
			// Add IST offset
			hour = hour + 5;
			minute = minute + 30;
			if(minute >= 60)
			{
				minute = minute - 60;
				hour = hour + 1;
			}
			if(hour >= 24)
			{
				hour = hour - 24;
				day = day + 1;
				// basic rollover (ok for appointment display)
			}
			monthName = monthNames.get(month - 1);
			// Format hour â†’ 12 hr
			ampm = "AM";
			displayHour = hour;
			if(hour == 0)
			{
				displayHour = 12;
			}
			else if(hour == 12)
			{
				ampm = "PM";
			}
			else if(hour > 12)
			{
				displayHour = hour - 12;
				ampm = "PM";
			}
			minuteStr = if(minute < 10,"0" + minute.toString(),minute.toString());
			formattedStart = day.toString() + " " + monthName + " " + year.toString() + ", " + displayHour.toString() + ":" + minuteStr + " " + ampm + " IST";
			endYear = endISO.substring(0,4).toLong();
			endMonth = endISO.substring(5,7).toLong();
			endDay = endISO.substring(8,10).toLong();
			endHour = endISO.substring(11,13).toLong();
			endMinute = endISO.substring(14,16).toLong();
			endHour = endHour + 5;
			endMinute = endMinute + 30;
			if(endMinute >= 60)
			{
				endMinute = endMinute - 60;
				endHour = endHour + 1;
			}
			if(endHour >= 24)
			{
				endHour = endHour - 24;
				endDay = endDay + 1;
			}
			endAMPM = "AM";
			endDispHour = endHour;
			if(endHour == 0)
			{
				endDispHour = 12;
			}
			else if(endHour == 12)
			{
				endAMPM = "PM";
			}
			else if(endHour > 12)
			{
				endDispHour = endHour - 12;
				endAMPM = "PM";
			}
			endMinStr = if(endMinute < 10,"0" + endMinute.toString(),endMinute.toString());
			formattedEnd = endDay.toString() + " " + monthName + " " + endYear.toString() + ", " + endDispHour.toString() + ":" + endMinStr + " " + endAMPM + " IST";
			username = "medkit";
			eventSlug = booking.get("eventType").get("slug");
			bookingUid = booking.get("uid");
			organizerEmail = booking.get("userPrimaryEmail");
			rescheduleUrl = "https://cal.com/" + username + "/" + eventSlug + "?rescheduleUid=" + bookingUid + "&rescheduledBy=" + organizerEmail + "&overlayCalendar=true";
			cancelUrl = "https://cal.com/booking/" + bookingUid + "?email=" + cleanEmail + "&eventTypeSlug=" + eventSlug + "&uid=" + bookingUid + "&cancel=true";
			finalMsg = finalMsg + "ğŸ—‚ï¸ *Appointment #" + count + "*\n" + "â€¢ *Title:* " + title + "\n" + "â€¢ *Starts:* " + formattedStart + "\n" + "â€¢ *Ends:* " + formattedEnd + "\n" + "â€¢ ğŸ” *Reschedule:* [Click here to reschedule](" + rescheduleUrl + ")\n" + "â€¢ âŒ *Cancel:* [Click here to cancel](" + cancelUrl + ")\n\n";
			count = count + 1;
			cardText = "";
			cardText = cardText + "*Appointment #" + (count - 1) + "*\n\n";
			cardText = cardText + "â€¢ *Title:* " + title + "\n";
			if(formattedStart != null && formattedStart != "")
			{
				cardText = cardText + "â€¢ *Starts:* **" + formattedStart + "**\n";
			}
			if(formattedEnd != null && formattedEnd != "")
			{
				cardText = cardText + "â€¢ *Ends:* **" + formattedEnd + "**\n";
			}
			linksList = List();
			readMap = Map();
			readMap.put("url",rescheduleUrl);
			readMap.put("text","Reschedule");
			linksList.add(readMap);
			cancelMap = Map();
			cancelMap.put("url",cancelUrl);
			cancelMap.put("text","Cancel");
			linksList.add(cancelMap);
			card = Map();
			card.put("type","links");
			card.put("text",cardText);
			card.put("image",staticImage);
			card.put("image_position","fit");
			card.put("links",linksList);
			cards.add(card);
		}
		response.put("action","context");
		response.put("context_id","consult_verify_otp");
		q = Map();
		q.put("name","sched_otp");
		q.put("replies",cards);
		sugs = List();
		sugs.add("Refresh");
		sugs.add("Main Menu");
		q.put("suggestions",sugs);
		response.put("questions",{q});
		return response;
	}
	if(userOtp == "Main Menu" || userOtp == "main menu")
	{
		response.put("action","context");
		response.put("context_id","mainmenu");
		question = {"name":"select","replies":{"Hey buddy ğŸ™‹â€â™‚ï¸ Welcome to **MedKit** ğŸ©º! I'm here to guide you. Tell me what you'd like to do!"},"suggestions":{"MedKit Wellness Hub ğŸŒ¿","ğŸ‹ï¸ FitZone","ProcureX ğŸ›’","ğŸ’¬ Motivational Boost","ğŸ¤ Consult an Expert","ğŸ“ Help Desk"}};
		response.put("questions",{question});
		return response;
	}
	if(userOtp == null || userOtp == "" || userOtp.length() < 3)
	{
		response.put("action","context");
		response.put("context_id","consult_verify_otp");
		q = Map();
		q.put("name","sched_otp");
		q.put("replies",{"ğŸ“© Please enter the **6-digit OTP** we just sent you."});
		q.put("input",{"type":"name"});
		q.put("suggestions",{"Try Again","Main Menu"});
		response.put("questions",{q});
		return response;
	}
	sessId = "";
	phone = "";
	attempts = 0;
	try 
	{
		vsResp1 = zoho.salesiq.visitorsession.get(portalId,"consult_otp_session");
		if(vsResp1.containsKey("data"))
		{
			sessId = ifnull(vsResp1.get("data").get("consult_otp_session"),"");
		}
	}
	catch (e)
	{
		sessId = "";
	}
	try 
	{
		vsResp2 = zoho.salesiq.visitorsession.get(portalId,"consult_phone");
		if(vsResp2.containsKey("data"))
		{
			phone = ifnull(vsResp2.get("data").get("consult_phone"),"");
		}
	}
	catch (e)
	{
		phone = "";
	}
	try 
	{
		vsResp3 = zoho.salesiq.visitorsession.get(portalId,"consult_otp_attempts");
		if(vsResp3.containsKey("data"))
		{
			attempts = ifnull(vsResp3.get("data").get("consult_otp_attempts"),0).toLong();
		}
	}
	catch (e)
	{
		attempts = 0;
	}
	if(sessId == null || sessId == "")
	{
		response.put("action","context");
		response.put("context_id","consult_phone");
		q = Map();
		q.put("name","sched_phone");
		q.put("replies",{"âš ï¸ No active OTP session found. Please **Re-enter Your Phone Number** to request a new OTP."});
		q.put("input",{"type":"name"});
		response.put("questions",{q});
		return response;
	}
	if(attempts >= MAX_OTP_ATTEMPTS_LOCAL)
	{
		try 
		{
			tmp = Map();
			tmp.put("consult_otp_session","");
			zoho.salesiq.visitorsession.set(portalId,tmp);
		}
		catch (e)
		{
		}
		try 
		{
			tmp = Map();
			tmp.put("consult_otp_attempts",0);
			zoho.salesiq.visitorsession.set(portalId,tmp);
		}
		catch (e)
		{
		}
		try 
		{
			tmp = Map();
			tmp.put("consult_otp_sent_ts","");
			zoho.salesiq.visitorsession.set(portalId,tmp);
		}
		catch (e)
		{
		}
		response.put("action","context");
		response.put("context_id","consult_phone");
		q = Map();
		q.put("name","sched_phone");
		q.put("replies",{"âŒ Too many incorrect attempts. Please **Re-Enter Your Phone Number** to request a fresh OTP."});
		q.put("input",{"type":"name"});
		response.put("questions",{q});
		return response;
	}
	try 
	{
		tmp = Map();
		tmp.put("consult_otp_attempts",attempts + 1);
		zoho.salesiq.visitorsession.set(portalId,tmp);
	}
	catch (e)
	{
	}
	verifyUrl = "https://2factor.in/API/V1/" + API_KEY_PLACEHOLDER + "/SMS/VERIFY/" + sessId + "/" + userOtp;
	verifyResp = Map();
	try 
	{
		rawv = getUrl(verifyUrl);
		try 
		{
			verifyResp = rawv.toMap();
		}
		catch (e)
		{
			verifyResp = rawv;
		}
	}
	catch (e)
	{
		verifyResp = Map();
		verifyResp.put("Status","Error");
		verifyResp.put("Details","Verification failed: " + e.toString());
	}
	verified = false;
	reason = "";
	try 
	{
		if(verifyResp.containsKey("Details"))
		{
			d = verifyResp.get("Details").toString().toLowerCase();
			if(d.contains("otp matched"))
			{
				verified = true;
			}
			else
			{
				reason = verifyResp.get("Details");
			}
		}
		else
		{
			if(verifyResp.containsKey("Status"))
			{
				sts = verifyResp.get("Status").toString().toLowerCase();
				if(sts.equals("success"))
				{
					verified = true;
				}
			}
		}
	}
	catch (e)
	{
	}
	if(verified)
	{
		try 
		{
			tmp = Map();
			tmp.put("consult_phone_verified",true);
			tmp.put("consult_user_phone",phone);
			zoho.salesiq.visitorsession.set(portalId,tmp);
		}
		catch (e)
		{
		}
		try 
		{
			tmp = Map();
			tmp.put("my_appt_verified",true);
			zoho.salesiq.visitorsession.set(portalId,tmp);
		}
		catch (e)
		{
		}
		try 
		{
			tmp = Map();
			tmp.put("consult_otp_session","");
			zoho.salesiq.visitorsession.set(portalId,tmp);
		}
		catch (e)
		{
		}
		try 
		{
			tmp = Map();
			tmp.put("consult_otp_attempts",0);
			zoho.salesiq.visitorsession.set(portalId,tmp);
		}
		catch (e)
		{
		}
		try 
		{
			tmp = Map();
			tmp.put("consult_otp_sent_ts","");
			zoho.salesiq.visitorsession.set(portalId,tmp);
		}
		catch (e)
		{
		}
		// ensure nf_email is present (ProcureX logic)
		nfEmail = "";
		try 
		{
			tmpResp2 = zoho.salesiq.visitorsession.get(portalId,"nf_email");
			if(tmpResp2.containsKey("data"))
			{
				nfEmail = ifnull(tmpResp2.get("data").get("nf_email"),"");
			}
		}
		catch (e)
		{
			nfEmail = "";
		}
		if(nfEmail == null || nfEmail.trim() == "")
		{
			response.put("action","context");
			response.put("context_id","procurex");
			q = Map();
			q.put("name","procurex");
			q.put("replies",{"âš ï¸ We couldn't find your verified email. Please verify email via first."});
			q.put("suggestions",{"Main Menu"});
			response.put("questions",{q});
			return response;
		}
		// Both phone verified and nf_email exists -> fetch cal.com bookings (same logic)
		userEmail = nfEmail;
		bookingURL = "https://api.cal.com/v2/bookings?email=" + userEmail;
		bookingResp = Map();
		try 
		{
			bookingResp = invokeurl
			[
				url :bookingURL
				type :GET
				headers:{"Authorization":CAL_API_KEY}
			];
		}
		catch (e)
		{
			bookingResp = Map();
			bookingResp.put("status","error");
		}
		if(bookingResp.get("status") != "success")
		{
			response.put("action","context");
			response.put("context_id","my_appointments_completed");
			q = Map();
			q.put("name","my_appointments_result");
			q.put("replies",{"âŒ Could not fetch your appointments. Please try again later."});
			q.put("suggestions",{"Main Menu","Back"});
			response.put("questions",{q});
			return response;
		}
		bookings = bookingResp.get("data").get("bookings");
		myBookings = List();
		for each  b in bookings
		{
			attendees = ifnull(b.get("attendees"),List());
			for each  a in attendees
			{
				if(a.get("email") == userEmail)
				{
					myBookings.add(b);
				}
			}
		}
		if(myBookings.isEmpty())
		{
			response.put("action","context");
			response.put("context_id","my_appointments_completed");
			q = Map();
			q.put("name","my_appointments_result");
			q.put("replies",{"ğŸ˜• No appointments found for *" + userEmail + "*"});
			q.put("suggestions",{"Main Menu"});
			response.put("questions",{q});
			return response;
		}
		// build and return cards exactly as original booking display
		finalMsg = "ğŸ“… *Your Appointments*\n\n";
		count = 1;
		cleanEmail = userEmail.replaceAll(" ","%20");
		cards = List();
		staticImage = "https://image2url.com/images/1765648240188-21fc1436-74ed-446e-a15b-f4bca8e87299.jpg";
		monthNames = {"Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"};
		for each  booking in myBookings
		{
			title = booking.get("title");
			startISO = booking.get("startTime");
			endISO = booking.get("endTime");
			year = startISO.substring(0,4).toLong();
			month = startISO.substring(5,7).toLong();
			day = startISO.substring(8,10).toLong();
			hour = startISO.substring(11,13).toLong();
			minute = startISO.substring(14,16).toLong();
			hour = hour + 5;
			minute = minute + 30;
			if(minute >= 60)
			{
				minute = minute - 60;
				hour = hour + 1;
			}
			if(hour >= 24)
			{
				hour = hour - 24;
				day = day + 1;
			}
			monthName = monthNames.get(month - 1);
			ampm = "AM";
			displayHour = hour;
			if(hour == 0)
			{
				displayHour = 12;
			}
			else if(hour == 12)
			{
				ampm = "PM";
			}
			else if(hour > 12)
			{
				displayHour = hour - 12;
				ampm = "PM";
			}
			minuteStr = if(minute < 10,"0" + minute.toString(),minute.toString());
			formattedStart = day.toString() + " " + monthName + " " + year.toString() + ", " + displayHour.toString() + ":" + minuteStr + " " + ampm + " IST";
			endYear = endISO.substring(0,4).toLong();
			endMonth = endISO.substring(5,7).toLong();
			endDay = endISO.substring(8,10).toLong();
			endHour = endISO.substring(11,13).toLong();
			endMinute = endISO.substring(14,16).toLong();
			endHour = endHour + 5;
			endMinute = endMinute + 30;
			if(endMinute >= 60)
			{
				endMinute = endMinute - 60;
				endHour = endHour + 1;
			}
			if(endHour >= 24)
			{
				endHour = endHour - 24;
				endDay = endDay + 1;
			}
			endAMPM = "AM";
			endDispHour = endHour;
			if(endHour == 0)
			{
				endDispHour = 12;
			}
			else if(endHour == 12)
			{
				endAMPM = "PM";
			}
			else if(endHour > 12)
			{
				endDispHour = endHour - 12;
				endAMPM = "PM";
			}
			endMinStr = if(endMinute < 10,"0" + endMinute.toString(),endMinute.toString());
			formattedEnd = endDay.toString() + " " + monthName + " " + endYear.toString() + ", " + endDispHour.toString() + ":" + endMinStr + " " + endAMPM + " IST";
			username = "medkit";
			eventSlug = booking.get("eventType").get("slug");
			bookingUid = booking.get("uid");
			organizerEmail = booking.get("userPrimaryEmail");
			rescheduleUrl = "https://cal.com/" + username + "/" + eventSlug + "?rescheduleUid=" + bookingUid + "&rescheduledBy=" + organizerEmail + "&overlayCalendar=true";
			cancelUrl = "https://cal.com/booking/" + bookingUid + "?email=" + cleanEmail + "&eventTypeSlug=" + eventSlug + "&uid=" + bookingUid + "&cancel=true";
			finalMsg = finalMsg + "ğŸ—‚ï¸ *Appointment #" + count + "*\n" + "â€¢ *Title:* " + title + "\n" + "â€¢ *Starts:* " + formattedStart + "\n" + "â€¢ *Ends:* " + formattedEnd + "\n" + "â€¢ ğŸ” *Reschedule:* [Click here to reschedule](" + rescheduleUrl + ")\n" + "â€¢ âŒ *Cancel:* [Click here to cancel](" + cancelUrl + ")\n\n";
			cardText = "";
			cardText = cardText + "*Appointment #" + count + "*\n\n";
			cardText = cardText + "â€¢ *Title:* " + title + "\n";
			if(formattedStart != null && formattedStart != "")
			{
				cardText = cardText + "â€¢ *Starts:* **" + formattedStart + "**\n";
			}
			if(formattedEnd != null && formattedEnd != "")
			{
				cardText = cardText + "â€¢ *Ends:* **" + formattedEnd + "**\n";
			}
			linksList = List();
			readMap = Map();
			readMap.put("url",rescheduleUrl);
			readMap.put("text","Reschedule");
			linksList.add(readMap);
			cancelMap = Map();
			cancelMap.put("url",cancelUrl);
			cancelMap.put("text","Cancel");
			linksList.add(cancelMap);
			card = Map();
			card.put("type","links");
			card.put("text",cardText);
			card.put("image",staticImage);
			card.put("image_position","fit");
			card.put("links",linksList);
			cards.add(card);
			count = count + 1;
		}
		response.put("action","context");
		response.put("context_id","consult_verify_otp");
		q = Map();
		q.put("name","sched_otp");
		q.put("replies",cards);
		sugs = List();
		sugs.add("Refresh");
		sugs.add("Main Menu");
		q.put("suggestions",sugs);
		response.put("questions",{q});
		return response;
	}
	else
	{
		try 
		{
			tmpc = Map();
			tmpc.put("consult_otp_session","");
			zoho.salesiq.visitorsession.set(portalId,tmpc);
		}
		catch (e)
		{
		}
		// build readable failure message (do concatenation outside of inline literal)
		failReason = "";
		try 
		{
			if(reason != null && reason != "")
			{
				failReason = " Reason: " + reason;
			}
		}
		catch (e)
		{
			failReason = "";
		}
		replyMsg = "âŒ OTP verification failed!" + failReason + "\nNo worries â€” please re-enter your phone number to request a new OTP.";
		response.put("action","context");
		response.put("context_id","my_appointments_phone_collect");
		q = Map();
		q.put("name","sched_phone");
		q.put("replies",{replyMsg});
		q.put("input",{"type":"name","placeholder":"9198xxxxxxxx"});
		q.put("suggestions",{"Try Again","Main Menu"});
		response.put("questions",{q});
		return response;
	}
}
if(context_id != null && context_id.equals("consult_schedule_name"))
{
	response = Map();
	uname = "Friend";
	try 
	{
		uname = ifnull(answers.get("sched_name").get("text"),"Friend");
	}
	catch (e)
	{
		uname = "Friend";
	}
	bookingUrl = "https://cal.com/medkit/medkit-health-appointment";
	try 
	{
		eventTypeId = 3978675;
		apiResponse = invokeurl
		[
			url :"https://api.cal.com/v2/event-types/" + eventTypeId
			type :GET
			connection:"cal_com_medkit"
		];
		info "ğŸ“Œ Cal API Response: " + apiResponse;
		if(apiResponse != null && apiResponse.containsKey("data"))
		{
			data = apiResponse.get("data");
			if(data.containsKey("scheduling_url"))
			{
				bookingUrl = data.get("scheduling_url");
			}
			else if(data.containsKey("url"))
			{
				bookingUrl = data.get("url");
			}
			else if(data.containsKey("slug"))
			{
				slug = data.get("slug");
				bookingUrl = "https://cal.com/" + slug;
			}
		}
	}
	catch (e2)
	{
		info "âŒ Cal API Error, using fallback. Error: " + e2.toString();
	}
	card = Map();
	card.put("type","links");
	card.put("text","Hi " + uname + " ğŸ‘‹\n\nğŸ“… **Your MedKit Appointment is Ready!**\nSecure your preferred slot below:");
	card.put("image","https://zoophagous-yellow-nmci9jkywb-l83k0cucwa.edgeone.dev/BOOKINGS.jpg");
	links = List();
	btn = Map();
	btn.put("url",bookingUrl);
	btn.put("text","Book Appointment");
	links.add(btn);
	card.put("links",links);
	q = Map();
	q.put("name","consultopt");
	q.put("replies",{card});
	q.put("suggestions",{"Main Menu","Back"});
	response.put("action","context");
	response.put("context_id","consultopt");
	response.put("questions",{q});
	return response;
}
if(context_id != null && context_id.equals("game_flow"))
{
	gameName = "";
	if(answers.containsKey("game_name"))
	{
		gameName = ifnull(answers.get("game_name").get("text"),"").trim();
	}
	if(gameName.equalsIgnoreCase("Main Menu") || gameName.equalsIgnoreCase("mainmenu"))
	{
		response.put("action","context");
		response.put("context_id","mainmenu");
		question = {"name":"select","replies":{"Hey buddy ğŸ™‹â€â™‚ï¸ Welcome to **MedKit** ğŸ©º! I'm here to guide you. Tell me what you'd like to do!"},"suggestions":{"MedKit Wellness Hub ğŸŒ¿","ğŸ‹ï¸ FitZone","ProcureX ğŸ›’","ğŸ’¬ Motivational Boost","ğŸ¤ Consult an Expert","ğŸ“ Help Desk"}};
		response.put("questions",{question});
		return response;
	}
	if(gameName == "" || gameName.equalsIgnoreCase("Play Another"))
	{
		response.put("action","context");
		response.put("context_id","game_flow");
		q = {"name":"game_name","replies":{"Please enter a game name ğŸ®","**Eg: subway surf, temple run**"},"input":{"type":"name","placeholder":"Eg. Subway Surfers"},"suggestions":{"Subway Surfers","Temple Run","Moto X3M","Main Menu"}};
		response.put("questions",{q});
		return response;
	}
	session_map = Map();
	session_map.put("selected_game",gameName);
	ignoreResp = zoho.salesiq.visitorsession.set("trycatchus",session_map,"salesiqconnection");
	response.put("action","context");
	response.put("context_id","game_confirm");
	q = {"name":"game_confirm_reply","replies":{"Nice choice! You want to play *" + gameName + "* ğŸ˜„","Shall I open it for you?"},"suggestions":{"Go Ahead","Main Menu"}};
	response.put("questions",{q});
	return response;
}
if(context_id != null && context_id.equals("game_confirm"))
{
	pick = "";
	if(answers.containsKey("game_confirm_reply"))
	{
		pick = ifnull(answers.get("game_confirm_reply").get("text"),"").toLowerCase();
	}
	gameName = "";
	stored = zoho.salesiq.visitorsession.get("trycatchus","selected_game","salesiqconnection");
	if(stored != null)
	{
		gameName = ifnull(stored.get("selected_game"),"");
	}
	if(gameName == "")
	{
		response.put("action","context");
		response.put("context_id","game_flow");
		q = {"name":"game_name","replies":{"Oops, I lost your game name ğŸ˜…","Tell me again which game you want to play?"},"input":{"type":"name","placeholder":"Eg. Subway Surfers"},"suggestions":{"Subway Surfers","Temple Run","Moto X3M","Main Menu"}};
		response.put("questions",{q});
		return response;
	}
	if(pick.contains("main menu"))
	{
		response.put("action","context");
		response.put("context_id","mainmenu");
		question = {"name":"select","replies":{"Hey buddy ğŸ™‹â€â™‚ï¸ Welcome to **MedKit** ğŸ©º! I'm here to guide you. Tell me what you'd like to do!"},"suggestions":{"MedKit Wellness Hub ğŸŒ¿","ğŸ‹ï¸ FitZone","ProcureX ğŸ›’","ğŸ’¬ Motivational Boost","ğŸ¤ Consult an Expert","ğŸ“ Help Desk"}};
		response.put("questions",{question});
		return response;
	}
	if(!pick.contains("go"))
	{
		response.put("action","context");
		response.put("context_id","game_confirm");
		q = {"name":"game_confirm_reply","replies":{"Please choose an option ğŸ‘‡"},"suggestions":{"Go Ahead","Main Menu"}};
		response.put("questions",{q});
		return response;
	}
	gameKey = gameName.toLowerCase().trim();
	slugMap = Map();
	slugMap.put("subway surf","subway-surfers");
	slugMap.put("subway surfers","subway-surfers");
	slugMap.put("temple run","temple-run-2");
	slugMap.put("moto x3m","moto-x3m");
	slug = ifnull(slugMap.get(gameKey),"");
	if(slug == "")
	{
		slug = gameKey.replaceAll(" ","-");
	}
	pokiUrl = "https://poki.com/en/g/" + slug;
	pokiCollage = "https://wooden-copper-ysi2rzqaqi-fmkt3qeo0j.edgeone.dev/POKI%20GAMES.png";
	playIcon = "https://cdn-icons-png.flaticon.com/512/64/64595.png";
	linksList = List();
	playMap = Map();
	playMap.put("url",pokiUrl);
	playMap.put("text","Play the Game");
	// visible label under the image
	playMap.put("icon",playIcon);
	linksList.add(playMap);
	card = Map();
	card.put("type","links");
	card.put("text",gameName + " â€” Play now on Poki.");
	card.put("image",pokiCollage);
	card.put("image_position","fit");
	card.put("links",linksList);
	cards = List();
	cards.add(card);
	response.put("action","context");
	response.put("context_id","game_flow");
	q = Map();
	q.put("name","game_name");
	q.put("replies",cards);
	q.put("suggestions",{"Play Another","Main Menu"});
	response.put("questions",{q});
	return response;
}
if(context_id != null && context_id.equals("mainmenu"))
{
	ans_lower = "";
	try 
	{
		ans_lower = ifnull(answers.get("mainmenu").get("text"),"").toLowerCase();
	}
	catch (e)
	{
		ans_lower = "";
	}
	if(ans_lower == "")
	{
		for each  k in answers.keys()
		{
			temp_val = ifnull(answers.get(k).get("text"),"");
			if(temp_val != "")
			{
				ans_lower = temp_val.toLowerCase();
				break;
			}
		}
	}
	if(ans_lower.equalsIgnoreCase("MedKit Wellness Hub ğŸŒ¿") || ans_lower.equalsIgnoreCase("MedKit Wellness Hub"))
	{
		response = Map();
		response.put("action","context");
		response.put("context_id","care_main");
		q = {"name":"care_main","replies":{"ğŸ©º Welcome to *MedKit Wellness Hub*!"},"suggestions":{"Child Care ğŸ‘¶","Glow Care âœ¨","Health Care ğŸ©º","ğŸ§  Mind Care","Weather Care ğŸ˜·","Main Menu"}};
		response.put("questions",{q});
		return response;
	}
	else if(ans_lower.equalsIgnoreCase("procurex ğŸ›’") || ans_lower.equalsIgnoreCase("procurex"))
	{
		response.put("action","context");
		response.put("context_id","procurex");
		question = {"name":"procurex","replies":{"Welcome to ProcureX ğŸ›’ â€” explore our **MedKit Premium Products ğŸ›ï¸** below:"},"suggestions":{"ğŸ›ï¸ MedKit Products","â„¹ï¸ About Purchasing","Main Menu"}};
		response.put("questions",{question});
		return response;
	}
	else if(ans_lower.equalsIgnoreCase("ğŸ’¬ motivational boost") || ans_lower.equalsIgnoreCase("motivational boost"))
	{
		response.put("action","context");
		response.put("context_id","depressedopt");
		question = {"name":"depressedOpt","replies":{"ğŸ˜Š Donâ€™t worry, your assistant is right here to lift you up ğŸ¤—"},"suggestions":{"Grab me some Books ğŸ“š","Spotify ğŸµ","Motivate me ğŸ’ª","Make me laugh ğŸ˜‚","MedTube ğŸ¥","Show me a meme ğŸ–¼ï¸","Tell me a story ğŸ“–","Play Games ğŸ®","Main Menu"}};
		response.put("questions",{question});
		return response;
	}
	else if(ans_lower.equalsIgnoreCase("ğŸ‹ï¸ FitZone"))
	{
		response.put("action","context");
		response.put("context_id","fitnessopt");
		question = {"name":"getFitnessOpt","replies":{"Welcome to **FitZone!** Being healthy and fit isn't a fad or a trendâ€”it's a lifestyle ğŸ’ªğŸ»"},"suggestions":{"Pregnancy ZoneğŸ¤°","Dietrix ğŸ¥—","Yoga ğŸ§˜","Exercise ğŸ‹ï¸","Wellness Meetup ğŸŒ¿","Main Menu"}};
		response.put("questions",{question});
		return response;
	}
	else if(ans_lower.equalsIgnoreCase("ğŸ¤ consult an expert") || ans_lower.equalsIgnoreCase("consult an expert"))
	{
		response.put("action","context");
		response.put("context_id","consultopt");
		question = {"name":"consultopt","replies":{"ğŸ˜ Welcome to **MedKit Expert Help!**"},"suggestions":{"â„¹ï¸ About","ğŸ“… Make an Appointment","ğŸ“˜ My Appointments","Main Menu"}};
		response.put("questions",{question});
		return response;
	}
	else if(ans_lower.equalsIgnoreCase("ğŸ“ help desk") || ans_lower.equalsIgnoreCase("help desk"))
	{
		response.put("action","context");
		response.put("context_id","help");
		helpText = "ğŸ“ *HELP DESK â€“ MEDKIT ASSISTANT*\n\nğŸ¤– *About MedKit*\nMedKit is your all-in-one smart healthcare assistant built to support your *health*, *mind*, *fitness*, *productivity*, and *daily wellness* in one place.\n\nâœ¨ *What MedKit Can Do (Use-Cases):*\nâ€¢ ğŸ§  *Mind Care* â€“ Helps you understand and manage your current mood.\nâ€¢ ğŸ©º *Health Care* â€“ Provides hospital search and emergency contact options and health news.\nâ€¢ ğŸ¤— *Care Assistant* â€“ Offers child care, skin care, weather care.\nâ€¢ ğŸ›’ *ProcureX* â€“ Lets you explore nutrition foods and fitness gadgets.\nâ€¢ ğŸ’¬ *Motivational Boost* â€“ Lifts your mood with quotes, jokes, stories, and more.\nâ€¢ ğŸ¥— *Dietrix* â€“ Suggests healthy diet tips to improve your daily lifestyle.\nâ€¢ ğŸ‹ï¸ *FitZone* â€“ Offers workout, yoga, and exercise recommendations.\nâ€¢ ğŸ¤ *Consult an Expert* â€“ Assists you in consulting or booking with experts.\nâ€¢*Team Behind MedKit*\n\nâ€¢ ğŸ‘¨â€ğŸ’» *Mohamed Silar M*\n  ğŸ“§ Email: *mohamedsilar26@gmail.com*\nâ€¢ ğŸ‘©â€ğŸ’» *Shanmuga Priya AR*\n  ğŸ“§ Email: *shanmugapriyaar0@gmail.com*\n\nğŸ’¡ *For instant support, simply continue using our bot â€” I'm always here to assist you!* ğŸ˜Š";
		question = {"name":"helpSugg","replies":{helpText},"suggestions":{"Main Menu"}};
		response.put("questions",{question});
		return response;
	}
	else
	{
		response.put("action","context");
		response.put("context_id","main menu");
		question = {"name":"done","replies":{"**Will you rate me out of 5 â­**"},"input":{"type":"star-rating","level":"5"},"suggestions":{"Main Menu"}};
		response.put("questions",{question});
		return response;
	}
}
response.put("action","context");
response.put("context_id","mainmenu");
question = {"name":"select","replies":{"Hey buddy ğŸ™‹â€â™‚ï¸ Welcome to **MedKit** ğŸ©º! I'm here to guide you. Tell me what you'd like to do!"},"suggestions":{"MedKit Wellness Hub ğŸŒ¿","ğŸ‹ï¸ FitZone","ProcureX ğŸ›’","ğŸ’¬ Motivational Boost","ğŸ¤ Consult an Expert","ğŸ“ Help Desk"}};
response.put("questions",{question});
return response;
